# ä¸€æ–‡å¸¦ä½ å±‚å±‚è§£é”ã€Œæ–‡ä»¶ä¸‹è½½ã€çš„å¥¥ç§˜

å¤§å®¶å¥½æˆ‘æ˜¯ç§‹é£ï¼Œä»Šå¤©å¸¦æ¥çš„ä¸»é¢˜æ˜¯å…³äº`æ–‡ä»¶ä¸‹è½½`ï¼Œåœ¨æˆ‘ä¹‹å‰æ›¾ç»å‘è¿‡ä¸€ç¯‡æ–‡ä»¶ä¸Šä¼ çš„æ–‡ç« ï¼ˆ[ä¸€æ–‡äº†è§£æ–‡ä»¶ä¸Šä¼ å…¨è¿‡ç¨‹ï¼ˆ1.8wå­—æ·±åº¦è§£æï¼Œè¿›é˜¶å¿…å¤‡](https://juejin.im/post/6844904106658643982) 200+ç‚¹èµï¼‰ï¼Œåå“è¿˜ä¸é”™ï¼Œæ—¶éš”å¤šæ—¥ï¼Œç”±äºæœ€è¿‘æœ‰ç ”ç©¶ä¸€äº›åª’ä½“ç›¸å…³çš„å·¥ä½œï¼Œå› æ­¤æ‰“ç®—å¯¹ä¸‹è½½åšä¸€ä¸ªæ•´ç†ï¼Œå› æ­¤ä»–çš„å…„å¼Ÿç¯‡è¯ç”Ÿäº†ï¼Œå¸¦ä½ é¢†ç•¥æ–‡ä»¶ä¸‹è½½çš„å¥¥ç§˜ã€‚æœ¬æ–‡ä¼šèŠ±è´¹ä½ è¾ƒé•¿çš„æ—¶é—´é˜…è¯»ï¼Œå»ºè®®å…ˆæ”¶è—/ç‚¹èµï¼Œç„¶åæŸ¥çœ‹ä½ æ„Ÿå…´è¶£çš„éƒ¨åˆ†ï¼Œå¹³æ—¶ä¹Ÿå¯ä»¥å……å½“å½“åšå­—å…¸çš„æ•ˆæœæ¥æŸ¥è¯¢ã€‚

:) ä¸æ•´ä¸çŸ¥é“ï¼Œä¸€æ•´ï¼Œå±…ç„¶æ•´å‡ºè¿™ä¹ˆå¤šæƒ…å†µï¼Œæˆ‘åªæ˜¯æƒ³ç®€å•åœ°åšä¸ªé¡µé¢ä»”ã€‚

## å‰è¨€

ä¸€å›¾è§ˆå…¨æ–‡ï¼Œå¯ä»¥å…ˆçœ‹çœ‹å¤§çº²é€‚ä¸é€‚åˆè‡ªå·±ï¼Œå¦‚æœä½ å–œæ¬¢åˆ™ç»§ç»­å¾€ä¸‹é˜…è¯»ã€‚

![ä¸€æ–‡äº†è§£æ–‡ä»¶ä¸‹è½½](https://s3.qiufengh.com/blog/ä¸€æ–‡äº†è§£æ–‡ä»¶ä¸‹è½½.png)

è¿™ä¸€èŠ‚å‘¢ï¼Œä¸»è¦ä»‹ç»ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œå¯¹ä¸€äº›åŸºç¡€çŸ¥è¯†çš„ä»‹ç»ï¼Œå¦‚æœä½ è§‰å¾—ä½ æ˜¯è¿™ä¸ªã€‚â¬‡ï¸â¬‡ï¸â¬‡ï¸ï¼Œä½ å¯ä»¥è·³è¿‡å‰è¨€ã€‚

![å’Œè£è€€ç‹è€…è¯´ä½ å˜›å‘¢ï¼Ÿ_è£è€€_ç‹è€…è¡¨æƒ…](http://wx2.sinaimg.cn/bmiddle/ceeb653ely1g0tken1v5aj20ly0iqgm8.jpg)

å‰ç«¯çš„æ–‡ä»¶ä¸‹è½½ä¸»è¦æ˜¯é€šè¿‡ `<a>` ï¼Œå†åŠ ä¸Š `download`å±æ€§,æœ‰äº†å®ƒä»¬è®©æˆ‘ä»¬çš„ä¸‹è½½å˜å¾—ç®€å•ã€‚

`download`æ­¤å±æ€§æŒ‡ç¤ºæµè§ˆå™¨ä¸‹è½½ URL è€Œä¸æ˜¯å¯¼èˆªåˆ°å®ƒï¼Œå› æ­¤å°†æç¤ºç”¨æˆ·å°†å…¶ä¿å­˜ä¸ºæœ¬åœ°æ–‡ä»¶ã€‚å¦‚æœå±æ€§æœ‰ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆæ­¤å€¼å°†åœ¨ä¸‹è½½ä¿å­˜è¿‡ç¨‹ä¸­ä½œä¸ºé¢„å¡«å……çš„æ–‡ä»¶åï¼ˆå¦‚æœç”¨æˆ·éœ€è¦ï¼Œä»ç„¶å¯ä»¥æ›´æ”¹æ–‡ä»¶åï¼‰ã€‚æ­¤å±æ€§å¯¹å…è®¸çš„å€¼æ²¡æœ‰é™åˆ¶ï¼Œä½†æ˜¯ `/` å’Œ `\` ä¼šè¢«è½¬æ¢ä¸ºä¸‹åˆ’çº¿ã€‚å¤§å¤šæ•°æ–‡ä»¶ç³»ç»Ÿé™åˆ¶äº†æ–‡ä»¶åä¸­çš„æ ‡ç‚¹ç¬¦å·ï¼Œæ•…æ­¤ï¼Œæµè§ˆå™¨å°†ç›¸åº”åœ°è°ƒæ•´å»ºè®®çš„æ–‡ä»¶åã€‚( æ‘˜è‡ª https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/a)

> **æ³¨æ„:**
>
> - æ­¤å±æ€§ä»…é€‚ç”¨äº[åŒæº URL](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)ã€‚
> - å°½ç®¡ HTTP URL éœ€è¦ä½äºåŒä¸€æºä¸­ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ [`blob:` URL](https://developer.mozilla.org/zh-CN/docs/Web/API/URL.createObjectURL) å’Œ [`data:` URL](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Data_URIs) ï¼Œä»¥æ–¹ä¾¿ç”¨æˆ·ä¸‹è½½ä½¿ç”¨ JavaScript ç”Ÿæˆçš„å†…å®¹ï¼ˆä¾‹å¦‚ä½¿ç”¨åœ¨çº¿ç»˜å›¾ Web åº”ç”¨ç¨‹åºåˆ›å»ºçš„ç…§ç‰‡ï¼‰ã€‚

å› æ­¤ä¸‹è½½ url ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ã€‚(æœ¬æ–‡å¤§éƒ¨åˆ†ä»¥ blob çš„æ–¹å¼è¿›è¡Œæ¼”ç¤º)

![image-20200830153314861](https://s3.qiufengh.com/blog/image-20200830153314861.png)

**å…¼å®¹æ€§**

å¯ä»¥çœ‹åˆ°å®ƒçš„å…¼å®¹æ€§ä¹Ÿéå¸¸çš„å¯è§‚ï¼ˆhttps://www.caniuse.com/#search=downloadï¼‰

![image-20200817232216749](https://s3.qiufengh.com/blog/image-20200817232216749.png)

ä¸ºäº†é¿å…å¾ˆå¤šä»£ç çš„é‡å¤æ€§ï¼Œå› ä¸ºæˆ‘æŠ½ç¦»å‡ºäº†å‡ ä¸ªå…¬å…±å‡½æ•°ã€‚(è¯¥éƒ¨åˆ†å¯è·³è¿‡ï¼Œåå­—éƒ½æ¯”è¾ƒå¯è¯»ï¼Œä¹‹åè‹¥æ˜¯é‡åˆ°ä¸æ˜ç™½åˆ™å¯ä»¥åœ¨è¿™é‡Œå¯»æ‰¾)

```js
export function downloadDirect(url) {
    const aTag = document.createElement('a');
    aTag.download = url.split('/').pop();
    aTag.href = url;
    aTag.click()
}
export function downloadByContent(content, filename, type) {
    const aTag = document.createElement('a');
    aTag.download = filename;
    const blob = new Blob([content], { type });
    const blobUrl = URL.createObjectURL(blob);
    aTag.href = blobUrl;
    aTag.click();
    URL.revokeObjectURL(blob);
}
export function downloadByDataURL(content, filename, type) {
    const aTag = document.createElement('a');
    aTag.download = filename;
    const dataUrl = `data:${type};base64,${window.btoa(unescape(encodeURIComponent(content)))}`;
    aTag.href = dataUrl;
    aTag.click();
}
export function downloadByBlob(blob, filename) {
    const aTag = document.createElement('a');
    aTag.download = filename;
    const blobUrl = URL.createObjectURL(blob);
    aTag.href = blobUrl;
    aTag.click();
    URL.revokeObjectURL(blob);
}
export function base64ToBlob(base64, type) {
    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const buffer = Uint8Array.from(byteNumbers);
    const blob = new Blob([buffer], { type });
    return blob;
}
```

ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…ğŸš…

(æ‰‹åŠ¨ç»™ä¸çœ‹ä»¥ä¸Šå†…å®¹çš„å¤§ä½¬ç”»åˆ†å‰²çº¿ï¼‰

ğŸ‡¨ğŸ‡³

> æ‰€æœ‰ç¤ºä¾‹Githubåœ°å€:  https://github.com/hua1995116/node-demo/tree/master/file-download
>
> åœ¨çº¿Demo: https://qiufeng.blue/demo/file-download/index.html

![å‰ç«¯æ–‡ä»¶ä¸‹è½½](https://s3.qiufengh.com/blog/å‰ç«¯æ–‡ä»¶ä¸‹è½½.png)

## åç«¯

> æœ¬æ–‡åç«¯æ‰€æœ‰ç¤ºä¾‹å‡ä»¥ koa / åŸç”Ÿ js å®ç°ã€‚

### åç«¯è¿”å›æ–‡ä»¶æµ

è¿™ç§æƒ…å†µéå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ç›´æ¥å°†åç«¯è¿”å›çš„æ–‡ä»¶æµä»¥æ–°çš„çª—å£æ‰“å¼€ï¼Œå³å¯ç›´æ¥ä¸‹è½½äº†ã€‚

```html
// å‰ç«¯ä»£ç 
<button id="oBtnDownload">ç‚¹å‡»ä¸‹è½½</button>
<script>
oBtnDownload.onclick = function(){
    window.open('http://localhost:8888/api/download?filename=1597375650384.jpg', '_blank')
}
</script>
```

```javascript
// åç«¯ä»£ç 
router.get('/api/download', async (ctx) => {
    const { filename } = ctx.query;
    const fStats = fs.statSync(path.join(__dirname, './static/', filename));
    ctx.set({
        'Content-Type': 'application/octet-stream',
        'Content-Disposition': `attachment; filename=${filename}`,
        'Content-Length': fStats.size
    });
    ctx.body = fs.readFileSync(path.join(__dirname, './static/', filename));
})
```

èƒ½å¤Ÿè®©æµè§ˆå™¨è‡ªåŠ¨ä¸‹è½½æ–‡ä»¶ï¼Œä¸»è¦æœ‰ä¸¤ç§æƒ…å†µ:

**ä¸€ç§ä¸ºä½¿ç”¨äº†``Content-Disposition``å±æ€§ã€‚**

æˆ‘ä»¬æ¥çœ‹çœ‹è¯¥å­—æ®µçš„æè¿°ã€‚

> åœ¨å¸¸è§„çš„HTTPåº”ç­”ä¸­ï¼Œ`Content-Disposition` å“åº”å¤´æŒ‡ç¤ºå›å¤çš„å†…å®¹è¯¥ä»¥ä½•ç§å½¢å¼å±•ç¤ºï¼Œæ˜¯ä»¥**å†…è”**çš„å½¢å¼ï¼ˆå³ç½‘é¡µæˆ–è€…é¡µé¢çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œè¿˜æ˜¯ä»¥**é™„ä»¶**çš„å½¢å¼ä¸‹è½½å¹¶ä¿å­˜åˆ°æœ¬åœ°   --- æ¥æº MDN(https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Disposition)

å†æ¥çœ‹çœ‹å®ƒçš„è¯­æ³•

```
Content-Disposition: inline
Content-Disposition: attachment
Content-Disposition: attachment; filename="filename.jpg"
```

å¾ˆç®€å•ï¼Œåªè¦è®¾ç½®æˆæœ€åä¸€ç§å½¢æ€æˆ‘å°±èƒ½æˆåŠŸè®©æ–‡ä»¶ä»åç«¯è¿›è¡Œä¸‹è½½äº†ã€‚

**å¦ä¸€ç§ä¸ºæµè§ˆå™¨æ— æ³•è¯†åˆ«çš„ç±»å‹**

ä¾‹å¦‚è¾“å…¥ http://localhost:8888/static/demo.shï¼Œæµè§ˆå™¨æ— æ³•è¯†åˆ«è¯¥ç±»å‹ï¼Œå°±ä¼šè‡ªåŠ¨ä¸‹è½½ã€‚

ä¸çŸ¥é“å°ä¼™ä¼´ä»¬æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„ä¸€ä¸ªæƒ…å†µï¼Œæˆ‘ä»¬è¾“å…¥ä¸€ä¸ªæ­£ç¡®çš„é™æ€ js åœ°å€ï¼Œæ²¡æœ‰é…ç½®`Content-Disposition`ï¼Œä½†æ˜¯å´ä¼šè¢«æ„å¤–çš„ä¸‹è½½ã€‚

ä¾‹å¦‚åƒä»¥ä¸‹çš„æƒ…å†µã€‚

![2020-08-30-17.01.52](https://s3.qiufengh.com/blog/2020-08-30-17.01.52.gif)

![006r3PQBjw1fav4dsikh6j308c0g5gm1](https://s3.qiufengh.com/blog/006r3PQBjw1fav4dsikh6j308c0g5gm1.jpg)

è¿™å¾ˆå¯èƒ½æ˜¯ç”±äºä½ çš„ `nginx` å°‘äº†è¿™ä¸€è¡Œé…ç½®.

```
include mime.types;
```

å¯¼è‡´é»˜è®¤èµ°äº† `application/octet-stream`ï¼Œæµè§ˆå™¨æ— æ³•è¯†åˆ«å°±ä¸‹è½½äº†æ–‡ä»¶ã€‚

### åç«¯è¿”å›é™æ€ç«™ç‚¹åœ°å€

é€šè¿‡é™æ€ç«™ç‚¹ä¸‹è½½ï¼Œè¿™é‡Œè¦åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€ç§ä¸ºå¯èƒ½è¯¥æœåŠ¡è‡ªå¸¦é™æ€ç›®å½•ï¼Œå³ä¸ºåŒæºæƒ…å†µï¼Œç¬¬äºŒç§æƒ…å†µä¸ºé€‚ç”¨äº†ç¬¬ä¸‰æ–¹é™æ€å­˜å‚¨å¹³å°ï¼Œä¾‹å¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ä¹‹ç±»çš„è¿›è¡Œæ‰˜ç®¡ï¼Œå³éåŒæºï¼ˆå½“ç„¶ä¹Ÿæœ‰äº›å¹³å°ç›´æ¥ä¼šè¿”å›ï¼‰ã€‚

#### åŒæº

åŒæºæƒ…å†µä¸‹æ˜¯éå¸¸ç®€å•ï¼Œå…ˆä¸Šä»£ç ï¼Œç›´æ¥è°ƒç”¨ä¸€ä¸‹å‡½æ•°å°±èƒ½è½»æ¾å®ç°ä¸‹è½½ã€‚

```js
import {downloadDirect} from '../js/utils.js';
axios.get('http://localhost:8888/api/downloadUrl').then(res => {
        if(res.data.code === 0) {
            downloadDirect(res.data.data.url);
        }
})
```

#### éåŒæº

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä» MDN ä¸Šçœ‹åˆ°ï¼Œè™½ç„¶ download é™åˆ¶äº†éåŒæºçš„æƒ…å†µï¼Œä½†æ˜¯ï¼ï¼ä½†æ˜¯ï¼ï¼ä½†æ˜¯å¯ä»¥ä½¿ç”¨ [`blob:` URL](https://developer.mozilla.org/zh-CN/docs/Web/API/URL.createObjectURL) å’Œ [`data:` URL](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Data_URIs) ï¼Œå› æ­¤æˆ‘ä»¬åªè¦å°†æ–‡ä»¶å†…å®¹è¿›è¡Œä¸‹è½½è½¬åŒ–æˆ `blob` å°±å¯ä»¥äº†ã€‚

æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹

![image-20200830174735143](https://s3.qiufengh.com/blog/image-20200830174735143.png)

```html
<button id="oBtnDownload">ç‚¹å‡»ä¸‹è½½</button>
    <script type="module">
        import {downloadByBlob} from '../js/utils.js';
        function download(url) {
            axios({
                method: 'get',
                url,
                responseType: 'blob'
            }).then(res => {
                downloadByBlob(res.data, url.split('/').pop());
            }) 
        }
        oBtnDownload.onclick = function(){
           axios.get('http://localhost:8888/api/downloadUrl').then(res => {
                if(res.data.code === 0) {
                    download(res.data.data.url);
                }
            })
        }
    </script>
```

ç°åœ¨éåŒæºçš„ä¹Ÿå¯ä»¥æ„‰å¿«åœ°ä¸‹è½½å•¦ã€‚

### åç«¯è¿”å›å­—ç¬¦ä¸²ï¼ˆbase64ï¼‰

æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šé‡åˆ°ä¸€äº›æ–°æ‰‹åç«¯è¿”å›å­—ç¬¦ä¸²çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼Œä½†æ˜¯æ¥äº†æˆ‘ä»¬ä¹Ÿä¸æ…Œï¼Œé¡ºä¾¿å¯ä»¥å‘åç«¯å°å“¥ç§€ä¸€æ³¢æ“ä½œï¼Œä¸ç®¡å•¥æ•°æ®ï¼Œå’±éƒ½èƒ½ç»™ä½ ä¸‹è½½ä¸‹æ¥ã€‚

>  ps: å‰ææ˜¯å®‰å…¨æ— æ±¡æŸ“çš„èµ„æº :)  , æ­£ç»æ–‡ç« çš„æ‹›ç‰Œé—ªé—ªå‘å…‰ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘éœ€è¦æ¨¡æ‹Ÿä¸‹åç«¯å°å“¥çš„éªšæ“ä½œï¼Œå› æ­¤æœ‰åç«¯ä»£ç ã€‚

![994b6f2egy1fgryfevtpvj208c08cmxd](https://s3.qiufengh.com/blog/994b6f2egy1fgryfevtpvj208c08cmxd.jpg)

æ ¸å¿ƒè¿‡ç¨‹

![image-20200830174752476](https://s3.qiufengh.com/blog/image-20200830174752476.png)

```js
// node ç«¯
router.get('/api/base64', async (ctx) => {
    const { filename } = ctx.query;
    const content = fs.readFileSync(path.join(__dirname, './static/', filename));
    const fStats = fs.statSync(path.join(__dirname, './static/', filename));
    console.log(fStats);
    ctx.body = {
        code: 0,
        data: {
            base64: content.toString('base64'),
            filename,
            type: mime.getType(filename)
        }
    }
})
```

```html
// å‰ç«¯
<button id="oBtnDownload">ç‚¹å‡»ä¸‹è½½</button>
<script type="module">
import {base64ToBlob, downloadByBlob} from '../js/utils.js';
function download({ base64, filename, type }) {
    const blob = base64ToBlob(blob, type);
    downloadByBlob(blob, filename);
}
oBtnDownload.onclick = function(){
    axios.get('http://localhost:8888/api/base64?filename=1597375650384.jpg').then(res => {
        if(res.data.code === 0) {
            download(res.data.data);
        }
    })
}
</script>
```

æ€è·¯å…¶å®è¿˜æ˜¯åˆ©ç”¨äº†æˆ‘ä»¬ä¸Šé¢è¯´çš„ `<a>` æ ‡ç­¾ã€‚ä½†æ˜¯åœ¨è¿™ä¸ªæ­¥éª¤å‰ï¼Œå¤šäº†ä¸€ä¸ªæ­¥éª¤å°±æ˜¯ï¼Œéœ€è¦å°†æˆ‘ä»¬çš„ `base64` å­—ç¬¦ä¸²è½¬åŒ–ä¸ºäºŒè¿›åˆ¶æµï¼Œè¿™ä¸ªä¸œè¥¿ï¼Œåœ¨æˆ‘çš„å‰ä¸€ç¯‡æ–‡ä»¶ä¸Šä¼ ä¸­ä¹Ÿå¸¸å¸¸æåˆ°ï¼Œæ¯•ç«Ÿæ–‡ä»¶å°±æ˜¯ä»¥äºŒè¿›åˆ¶æµçš„å½¢å¼å­˜åœ¨ã€‚ä¸è¿‡ä¹Ÿå¾ˆç®€å•ï¼Œjs æ‹¥æœ‰å†…ç½®å‡½æ•° `atob`ã€‚ æå¤§åœ°æé«˜äº†æˆ‘ä»¬è½¬æ¢çš„æ•ˆç‡ã€‚

## çº¯å‰ç«¯	

ä¸Šé¢ä»‹ç»å€ŸåŠ©åç«¯æ¥å®Œæˆæ–‡ä»¶ä¸‹è½½çš„ç›¸å…³æ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»‹ç»ä»‹ç»çº¯å‰ç«¯æ¥å®Œæˆæ–‡ä»¶ä¸‹è½½çš„ä¸€äº›æ–¹æ³•ã€‚

æ–¹æ³•ä¸€:  [`blob:` URL](https://developer.mozilla.org/zh-CN/docs/Web/API/URL.createObjectURL) 

![image-20200831230800538](https://s3.qiufengh.com/blog/image-20200831230800538.png)

æ–¹æ³•äºŒ: [`data:` URL](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Data_URIs)

![image-20200831230810963](https://s3.qiufengh.com/blog/image-20200831230810963.png)

ç”±äº data:URL ä¼šæœ‰é•¿åº¦çš„é™åˆ¶ï¼Œå› æ­¤ä¸‹é¢çš„æ‰€æœ‰ä¾‹å­éƒ½ä¼šé‡‡ç”¨ blob çš„æ–¹å¼æ¥è¿›è¡Œæ¼”ç¤ºã€‚

### json/text

ä¸‹è½½textå’Œjsonéå¸¸çš„ç®€å•ï¼Œå¯ä»¥ç›´æ¥æ„é€ ä¸€ä¸ª Blobã€‚

```
Blob(blobParts[, options])
è¿”å›ä¸€ä¸ªæ–°åˆ›å»ºçš„ Blob å¯¹è±¡ï¼Œå…¶å†…å®¹ç”±å‚æ•°ä¸­ç»™å®šçš„æ•°ç»„ä¸²è”ç»„æˆã€‚
```

```html
// html
<textarea name="" id="text" cols="30" rows="10"></textarea>
<button id="textBtn">ä¸‹è½½æ–‡æœ¬</button>
<p></p>
<textarea name="" id="json" cols="30" rows="10" disabled>
{
    "name": "ç§‹é£çš„ç¬”è®°"
}
</textarea>
<button id="jsonBtn">ä¸‹è½½JSON</button>
```

```js
//js
import {downloadByContent, downloadByDataURL} from '../js/utils.js';
textBtn.onclick = () => {
        const value = text.value;
        downloadByContent(value, 'hello.txt', 'text/plain');
  		// downloadByDataURL(value, 'hello.txt', 'text/plain');
}
jsonBtn.onclick = () => {
        const value = json.value;
        downloadByContent(value, 'hello.json', 'application/json');
     // downloadByDataURL(value, 'hello.json', 'application/json');
}
```

æ•ˆæœå›¾

![2020-08-30-17.53.32](https://s3.qiufengh.com/blog/2020-08-30-17.53.32.gif)

æ³¨é‡Šä»£ç ä¸º data:URL çš„å±•ç¤ºéƒ¨åˆ†ï¼Œç”±äºæ˜¯ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œå› æ­¤æˆ‘è®²å±•ç¤ºä»£ç ï¼Œåé¢éƒ½çœç•¥äº†ï¼Œä½†æ˜¯ä½ ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ `downloadByDataURL` æ–¹æ³•ï¼Œæ‰¾ä¸åˆ°è¯¥æ–¹æ³•çš„å®šä¹‰è¯·æ»‘åˆ°æ–‡ç« å¼€å¤´å“¦~

### excel

excel å¯ä»¥è¯´æ˜¯æˆ‘ä»¬éƒ¨åˆ†å‰ç«¯æ‰“äº¤é“å¾ˆæ·±çš„ä¸€ä¸ªåœºæ™¯ï¼Œä»€ä¹ˆæ•°æ®ä¸­å°ï¼Œå¤©å¤©éœ€è¦å¯¼å‡ºå„ç§æŠ¥è¡¨ã€‚ä»¥å‰éƒ½æ˜¯å‰ç«¯è¯·æ±‚åç«¯ï¼Œæ¥è·å–ä¸€ä¸ª excel æ–‡ä»¶åœ°å€ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥å±•ç¤ºä¸‹çº¯å‰ç«¯æ˜¯å¦‚ä½•å®ç°ä¸‹è½½excelã€‚

**ç®€å•excel**

è¡¨æ ¼é•¿è¿™ä¸ªæ¨¡æ ·ï¼Œæ¯”è¾ƒç®€é™‹çš„å½¢å¼

![image-20200829170347728](https://s3.qiufengh.com/blog/image-20200829170347728.png)

```js
const template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" '
            +'xmlns:x="urn:schemas-microsoft-com:office:excel" '
            +'xmlns="http://www.w3.org/TR/REC-html40">'
            +'<head>'
            +'</head>'
            +'<body><table border="1" style="width:60%; text-align: center;">{table}</table><\/body>'
            +'<\/html>';
    const context = template.replace('{table}', document.getElementById('excel').innerHTML);
    downloadByContent(context, 'qiufengblue.xls', 'application/vnd.ms-excel');
```

ä½†æ˜¯ç¼–å†™å¹¶ä¸å¤æ‚ï¼Œä¾æ—§æ˜¯å’Œæˆ‘ä»¬ä¹‹å‰ä¸€æ ·ï¼Œé€šè¿‡æ„é€ å‡º `excel` çš„æ ¼å¼ï¼Œè½¬åŒ–æˆ blob æ¥è¿›è¡Œä¸‹è½½ã€‚

æœ€ç»ˆå¯¼å‡ºçš„æ•ˆæœ

![image-20200829170625763](https://s3.qiufengh.com/blog/image-20200829170625763.png)

**element-ui å¯¼å‡ºè¡¨æ ¼**

æ²¡é”™ï¼Œè¿™ä¸ªå°±æ˜¯ `element-ui` å®˜æ–¹`table` çš„ä¾‹å­ã€‚

![image-20200829170543891](https://s3.qiufengh.com/blog/image-20200829170543891.png)

å¯¼å‡ºæ•ˆæœå¦‚ä¸‹ï¼Œå¯ä»¥è¯´éå¸¸å®Œç¾ã€‚

![image-20200829170912128](https://s3.qiufengh.com/blog/image-20200829170912128.png)

è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°äº†ä¸€ä¸ªæ’ä»¶ https://github.com/SheetJS/sheetjs

ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ã€‚

```html
<template>
      <el-table id="ele" border :data="tableData" style="width: 100%">
        <el-table-column prop="date" label="æ—¥æœŸ" width="180">
        </el-table-column>
        <el-table-column prop="name" label="å§“å" width="180">
        </el-table-column>
        <el-table-column prop="address" label="åœ°å€">
        </el-table-column>
      </el-table>
      <button @click="exportExcel">å¯¼å‡ºexcel</button>
</template>
<script>
...
methods: {
  exportExcel() {
     let wb = XLSX.utils.table_to_book(document.getElementById('ele'));
     XLSX.writeFile(wb, 'qiufeng.blue.xlsx');
	}
}
...
</script>

```

![å®Œç¾è¡¨æƒ…](https://s3.qiufengh.com/blog/6af89bc8gw1f8srz9343vj205i05ijr9.jpg)

### word

è®²å®Œäº† `excel `æˆ‘ä»¬å†æ¥è®²è®² `word` è¿™å¯æ˜¯ office ä¸‰å‰‘å®¢å¦å¤–ä¸€å¤§åˆ©å™¨ã€‚è¿™é‡Œæˆ‘ä»¬ä¾æ—§æ˜¯åˆ©ç”¨ä¸Šè¿°çš„ blob çš„æ–¹æ³•è¿›è¡Œä¸‹è½½ã€‚

**ç®€å•ç¤ºä¾‹**

![2020-08-29-20.13.25](https://s3.qiufengh.com/blog/2020-08-29-20.13.25.gif)



ä»£ç å±•ç¤º

```js
exportWord.onclick = () => {
    const template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" '
            +'xmlns:x="urn:schemas-microsoft-com:office:word" '
            +'xmlns="http://www.w3.org/TR/REC-html40">'
            +'<head>'
            +'</head>'
            +'<body>{table}<\/body>'
            +'<\/html>';
    const context = template.replace('{table}', document.getElementById('word').innerHTML);
    downloadByContent(context, 'qiufeng.blue.doc', 'application/msword');
}
```

æ•ˆæœå±•ç¤º

![image-20200830164208184](https://s3.qiufengh.com/blog/image-20200830164208184.png)

**ä½¿ç”¨ `docx.js `æ’ä»¶**

å¦‚æœä½ æƒ³æœ‰æ›´é«˜çº§çš„ç”¨æ³•ï¼Œå¯ä»¥ä½¿ç”¨ `docx.js `è¿™ä¸ªåº“ã€‚å½“ç„¶ç”¨ä¸Šè¿°æ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥é«˜çº§å®šåˆ¶çš„ã€‚

ä»£ç 

```html
<button type="button" onclick="generate()">ä¸‹è½½word</button>

    <script>
        async function generate() {
            const res = await axios({
                method: 'get',
                url: 'http://localhost:8888/static/1597375650384.jpg',
                responseType: 'blob'
            })
            const doc = new docx.Document();
            const image1 = docx.Media.addImage(doc, res.data, 300, 400)
            doc.addSection({
                properties: {},
                children: [
                    new docx.Paragraph({
                        children: [
                            new docx.TextRun("æ¬¢è¿å…³æ³¨[ç§‹é£çš„ç¬”è®°]å…¬ä¼—å·").break(),
                            new docx.TextRun("").break(),
                            new docx.TextRun("å®šæœŸå‘é€ä¼˜è´¨æ–‡ç« ").break(),
                            new docx.TextRun("").break(),
                            new docx.TextRun("ç¾å›¢ç‚¹è¯„2020æ ¡æ‹›-å†…æ¨").break(),
                        ],
                    }),
                    new docx.Paragraph(image1),
                ],
            }); 

            docx.Packer.toBlob(doc).then(blob => {
                console.log(blob);
                saveAs(blob, "qiufeng.blue.docx");
                console.log("Document created successfully");
            });
        }
    </script>
```

æ•ˆæœï¼ˆæ²¡æœ‰æ‰“å¹¿å‘Š...éšä¾¿æ‰¾äº†å¼ å›¾ï¼Œå¼ºè¡Œä¸æ‰¿è®¤ç³»åˆ—ï¼‰

![9150e4e5ly1fl8qavz6quj20hs0hsjvl](https://s3.qiufengh.com/blog/9150e4e5ly1fl8qavz6quj20hs0hsjvl.jpg)

![2020-08-30-18.32.09](https://s3.qiufengh.com/blog/2020-08-30-18.32.09.gif)

### zipä¸‹è½½

å‰ç«¯å‹ç¼©è¿˜æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œåœ¨ä¸€å®šçš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥èŠ‚çœæµé‡ã€‚è€Œè¿™ä¸ªåœºæ™¯æ¯”è¾ƒä½¿ç”¨äºï¼Œä¾‹å¦‚å‰ç«¯æ‰“åŒ…å›¾ç‰‡ä¸‹è½½ã€å‰ç«¯æ‰“åŒ…ä¸‹è½½å›¾æ ‡ã€‚

ä¸€å¼€å§‹æˆ‘ä»¥ä¸ºæˆ‘ https://tinypng.com/ å°±æ˜¯ç”¨äº†è¿™ä¸ªï¼Œç»“æœæˆ‘å‘ç°æˆ‘é”™äº†...ä»”ç»†ä¸€æƒ³ï¼Œå› ä¸ºå®ƒå‹ç¼©å¥½çš„å›¾ç‰‡æ˜¯å­˜åœ¨åç«¯çš„ï¼Œå¦‚æœä½¿ç”¨å‰ç«¯æ‰“åŒ…çš„è¯ï¼Œåè€Œè¦å»è¯·æ±‚æ‰€æœ‰å‹ç¼©çš„å›¾ç‰‡ä»è€Œæ¥è·å–å›¾ç‰‡æµã€‚å¦‚æœç”¨åç«¯å‹ç¼©è¯ï¼Œå¯ä»¥æœ‰æ•ˆèŠ‚çœæµé‡ã€‚å—¯ã€‚ã€‚ã€‚å¤±è´¥ä¾‹å­å‘Šç»ˆã€‚

åæ¥åˆä»¥ä¸ºhttps://www.iconfont.cn/æ‰“åŒ…ä¸‹è½½å›¾æ ‡çš„æ—¶å€™ï¼Œä½¿ç”¨äº†è¿™ä¸ªæ–¹æ¡ˆ....å‘ç°....æˆ‘åˆé”™äº†...ä½†æ˜¯æˆ‘ä»¬åˆ†æä¸€ä¸‹.

![image-20200829204540440](https://s3.qiufengh.com/blog/image-20200829204540440.png)

å®ƒå®˜ç½‘éƒ½æ˜¯ svg æ¸²æŸ“çš„å›¾æ ‡ï¼Œå¯¹äº svg ä¸‹è½½çš„æ—¶å€™ï¼Œå®Œå…¨å¯ä»¥ä½¿ç”¨å‰ç«¯æ‰“åŒ…ä¸‹è½½ã€‚ä½†æ˜¯ï¼Œå®ƒè¿˜æ”¯æŒ font ä»¥åŠ jpg æ ¼å¼ï¼Œæ‰€ä»¥ä¸ºäº†ç»Ÿä¸€ï¼Œé‡‡ç”¨äº†åç«¯ä¸‹è½½ï¼Œèƒ½å¤Ÿç†è§£ã€‚é‚£æˆ‘ä»¬å°±æ¥å®ç°è¿™ä¸ªå®ƒæœªå®Œæˆçš„åŠŸèƒ½ï¼Œå½“ç„¶æˆ‘ä»¬è¿˜éœ€è¦ç”¨åˆ°ä¸€ä¸ªæ’ä»¶ï¼Œå°±æ˜¯ [jszip](https://github.com/Stuk/jszip)ã€‚

è¿™é‡Œæˆ‘ä»ä»¥ä¸Šæ‰¾äº†ä¸¤ä¸ª svg çš„å›¾æ ‡ã€‚

![image-20200829204937044](https://s3.qiufengh.com/blog/image-20200829204937044.png)

å®ç°ä»£ç 

```js
download.onclick = () => {
        const zip = new JSZip();
        const svgList = [{
            id: 'demo1',
        }, {
            id: 'demo2',
        }]
        svgList.map(item => {
            zip.file(item.id + '.svg', document.getElementById(item.id).outerHTML);
        })
        zip.generateAsync({ 
            type: 'blob'
        }).then(function(content) {
            // ä¸‹è½½çš„æ–‡ä»¶å
            var filename = 'svg' + '.zip';
            // åˆ›å»ºéšè—çš„å¯ä¸‹è½½é“¾æ¥
            var eleLink = document.createElement('a');
            eleLink.download = filename;
            // ä¸‹è½½å†…å®¹è½¬å˜æˆblobåœ°å€
            eleLink.href = URL.createObjectURL(content);
            // è§¦å‘ç‚¹å‡»
            eleLink.click();
            // ç„¶åç§»é™¤
        });
    }
```

![2020-08-29-20.52.42](https://s3.qiufengh.com/blog/2020-08-29-20.52.42.gif)

æŸ¥çœ‹æ–‡ä»¶å¤¹ç›®å½•ï¼Œå·²ç»å°† SVG æ‰“åŒ…ä¸‹è½½å®Œæ¯•ã€‚

![image-20200829205329532](https://s3.qiufengh.com/blog/image-20200829205329532.png)

### æµè§ˆå™¨æ–‡ä»¶ç³»ç»Ÿï¼ˆå®éªŒæ€§ï¼‰

![image-20200817234129788](https://s3.qiufengh.com/blog/image-20200817234129788.png)

åœ¨æˆ‘ç”µè„‘ä¸Šéƒ½æœ‰è¿™ä¹ˆä¸€ä¸ªæµè§ˆå™¨ï¼Œç”¨æ¥å­¦ä¹ å’Œè°ƒè¯• `chrome` çš„æœ€æ–°æ–°ç‰¹æ€§, å¦‚æœä½ çš„ç”µè„‘æ²¡æœ‰ï¼Œå»ºè®®ä½ å®‰è£…ä¸€ä¸ªã€‚

ç©è¿™ä¸ªç‰¹æ€§éœ€è¦æ‰“å¼€ chrome çš„å®éªŒç‰¹æ€§ `chrome://flags` => `#native-file-system-api` => `enable`, å› ä¸ºå®éªŒç‰¹æ€§éƒ½ä¼šä¼´éšä¸€äº›å®‰å…¨æˆ–è€…å½±å“åŸæœ¬çš„æ¸²æŸ“çš„è¡Œä¸ºï¼Œå› æ­¤æˆ‘å†æ¬¡å¼ºçƒˆå»ºè®®ï¼Œä¸‹è½½ä¸€ä¸ªé‡‘ä¸é›€ç‰ˆæœ¬çš„ chrome æ¥è¿›è¡Œç©è€ã€‚

```html
<textarea name="" id="textarea" cols="30" rows="10"></textarea>
<p><button id="btn">ä¸‹è½½</button></p>
<script>
    btn.onclick = async () => {
        const handler = await window.chooseFileSystemEntries({
            type: 'save-file',
            accepts: [{
                description: 'Text file',
                extensions: ['txt'],
                mimeTypes: ['text/plain'],
            }],
        });

        const writer = await handler.createWritable();
        await writer.write(textarea.value);
        await writer.close();
    }
</script>
```

å®ç°èµ·æ¥éå¸¸ç®€å•ã€‚å´é£ä¸€èˆ¬çš„æ„Ÿè§‰ã€‚

![2020-08-18-00.13.29](https://s3.qiufengh.com/blog/2020-08-18-00.13.29.gif)

## å…¶ä»–åœºæ™¯

### H5æ–‡ä»¶ä¸‹è½½

ä¸€èˆ¬åœ¨ h5 ä¸‹è½½æ¯”è¾ƒå¤šçš„æ˜¯ pdf æˆ–è€…æ˜¯ apk çš„ä¸‹è½½ã€‚

#### Android

åœ¨å®‰å“æµè§ˆå™¨ä¸­ï¼Œæµè§ˆå™¨ç›´æ¥ä¸‹è½½æ–‡ä»¶ã€‚

#### ios

ç”±äºiosçš„é™åˆ¶ï¼Œæ— æ³•è¿›è¡Œä¸‹è½½ï¼Œå› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨å¤åˆ¶ url ï¼Œæ¥ä»£æ›¿ä¸‹è½½ã€‚

```js
import {downloadDirect} from '../js/utils.js';
const btn = document.querySelector('#download-ios');
if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) {
    const clipboard = new ClipboardJS(btn);
    clipboard.on('success', function () {
        alert('å·²å¤åˆ¶é“¾æ¥ï¼Œæ‰“å¼€æµè§ˆå™¨ç²˜è´´é“¾æ¥ä¸‹è½½');
    });
    clipboard.on('error', function (e) {
        alert('ç³»ç»Ÿç‰ˆæœ¬è¿‡ä½ï¼Œå¤åˆ¶é“¾æ¥å¤±è´¥');
    });
} else {
    btn.onclick = () => {
        downloadDirect(btn.dataset.clipboardText)
    }
}
```

#### æ›´å¤š

å¯¹äº apk ç­‰ä¸‹è½½åŒ…å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŒ…ï¼ˆæœ¬äººæš‚æ—¶æ²¡æœ‰è¯•éªŒï¼Œæ¥è§¦ä¸å¤šï¼Œå›å¤´ç†Ÿæ‚‰äº†å†å›æ¥è¡¥å……ã€‚ï¼‰

 https://github.com/jawidx/web-launch-app

![image-20200830145258473](https://s3.qiufengh.com/blog/image-20200830145258473.png)



### å¤§æ–‡ä»¶çš„åˆ†ç‰‡ä¸‹è½½

æœ€è¿‘åœ¨å¼€å‘åª’ä½“æµç›¸å…³çš„å·¥ä½œçš„æ—¶å€™ï¼Œå‘ç°åœ¨åŠ è½½ mp4 æ–‡ä»¶çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„ç°è±¡ï¼Œè§†é¢‘æµå¹¶ä¸éœ€è¦å°†æ•´ä¸ª mp4 ä¸‹è½½å®Œæ‰è¿›è¡Œæ’­æ”¾ï¼Œå¹¶ä¸”ä¼´éšäº†å¾ˆå¤šçŠ¶æ€ç ä¸º 206 çš„è¯·æ±‚ï¼Œä¹ä¸€çœ‹æœ‰ç‚¹åƒæµåª’ä½“(HLSç­‰)çš„éŸµå‘³ã€‚

![2020-08-29-21.31.29](https://s3.qiufengh.com/blog/2020-08-29-21.31.29.gif)



è§‰å¾—è¿™ä¸ªç°è±¡éå¸¸çš„æœ‰æ„æ€ï¼Œä»–èƒ½å¤Ÿåˆ†ç‰‡åœ°åŠ è½½èµ„æºï¼Œè¿™å¯¹äºä½“éªŒæˆ–è€…æ˜¯æµé‡çš„èŠ‚çœéƒ½æ˜¯éå¸¸å¤§çš„å¸®åŠ©ã€‚æœ€ç»ˆå‘ç°å®ƒå¸¦äº†ä¸€ä¸ªåä¸º Range çš„å¤´ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ MDN çš„è§£é‡Šã€‚

>  The **`Range`** æ˜¯ä¸€ä¸ªè¯·æ±‚é¦–éƒ¨ï¼Œå‘ŠçŸ¥æœåŠ¡å™¨è¿”å›æ–‡ä»¶çš„å“ªä¸€éƒ¨åˆ†ã€‚åœ¨ä¸€ä¸ª `Range` é¦–éƒ¨ä¸­ï¼Œå¯ä»¥ä¸€æ¬¡æ€§è¯·æ±‚å¤šä¸ªéƒ¨åˆ†ï¼ŒæœåŠ¡å™¨ä¼šä»¥ multipart æ–‡ä»¶çš„å½¢å¼å°†å…¶è¿”å›ã€‚å¦‚æœæœåŠ¡å™¨è¿”å›çš„æ˜¯èŒƒå›´å“åº”ï¼Œéœ€è¦ä½¿ç”¨ [`206`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/206) `Partial Content` çŠ¶æ€ç ã€‚  æ‘˜è‡ª MDN

è¯­æ³•

```
Range: <unit>=<range-start>-
Range: <unit>=<range-start>-<range-end>
Range: <unit>=<range-start>-<range-end>, <range-start>-<range-end>
Range: <unit>=<range-start>-<range-end>, <range-start>-<range-end>, <range-start>-<range-end>
```

#### Nodeå®ç°

æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†å®ƒçš„åŸç†ï¼Œå°±æ¥è‡ªå·±å®ç°ä¸€ä¸‹ã€‚

```js
router.get('/api/rangeFile', async(ctx) => {
    const { filename } = ctx.query;
    const { size } = fs.statSync(path.join(__dirname, './static/', filename));
    const range = ctx.headers['range'];
    if (!range) {
        ctx.set('Accept-Ranges', 'bytes');
        ctx.body = fs.readFileSync(path.join(__dirname, './static/', filename));
        return;
    }
    const { start, end } = getRange(range);
    if (start >= size || end >= size) {
        ctx.response.status = 416;
        ctx.set('Content-Range', `bytes */${size}`);
        ctx.body = '';
        return;
    }
    ctx.response.status = 206;
    ctx.set('Accept-Ranges', 'bytes');
    ctx.set('Content-Range', `bytes ${start}-${end ? end : size - 1}/${size}`);
    ctx.body = fs.createReadStream(path.join(__dirname, './static/', filename), { start, end });
})
```

#### Nginxå®ç°

å‘ç° nginx ä¸éœ€è¦å†™ä»»ä½•ä»£ç å°±é»˜è®¤æ”¯æŒäº† range å¤´ï¼Œæƒ³ç€æˆ‘ä¸€å®šçŸ¥é“å®ƒåˆ°åº•æ˜¯æ”¯æŒï¼Œè¿˜æ˜¯åŠ å…¥äº†ä»€ä¹ˆæ¨¡å—ï¼Œæˆ–è€…æ˜¯æˆ‘é»˜è®¤å¼€å¯äº†ä»€ä¹ˆé…ç½®ï¼Œæ‰¾äº†åŠå¤©æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆé¢å¤–çš„é…ç½®ã€‚

![3630px-Nginx_logo-1](https://s3.qiufengh.com/blog/3630px-Nginx_logo-1.png)

æ­£å½“æˆ‘å‡†å¤‡æ”¾å¼ƒçš„æ—¶å€™ï¼Œçµå…‰ä¸€ç°ï¼Œå»çœ‹çœ‹æºç å§ï¼Œè¯´ä¸å®šä¼šæœ‰å‘ç°ï¼Œå»æŸ¥äº† nginx æºç ç›¸å…³çš„å†…å®¹ï¼Œç”¨äº†æƒ¯ç”¨çš„åæ¨æ–¹å¼ï¼Œæ‰å‘ç°åŸæ¥æ˜¯`max_ranges`è¿™ä¸ªå­—æ®µã€‚

https://github.com/nginx/nginx/blob/release-1.13.6/src/http/modules/ngx_http_range_filter_module.c#L166

è¿™ä¹Ÿæ€ªæˆ‘ä¸€å¼€å§‹æ–‡æ¡£é˜…è¯»ä¸å¤Ÿä»”ç»†ï¼Œæµªè´¹äº†å¤§é‡çš„æ—¶é—´ã€‚

:) å…¶å®æˆ‘å¯¹ nginx æºç ä¹Ÿä¸ç†Ÿæ‚‰ï¼Œè¿™é‡Œå¯ä»¥ç”¨ä¸ªå°æŠ€å·§ï¼Œç›´æ¥åœ¨æºç åº“ æœç´¢ 206 ç„¶å å‘ç°äº†ä¸€ä¸ªå®å‘½ä»¤

```
#define NGX_HTTP_PARTIAL_CONTENT           206
```

ç„¶åé¡ºè—¤æ‘¸ç“œï¼Œç›´æ¥æ‰¾åˆ°è¿™ä¸ªå®å‘½ä»¤`NGX_HTTP_PARTIAL_CONTENT`ç”¨åˆ°çš„åœ°æ–¹ï¼Œè¿™æ ·ä¸€æ­¥ä¸€æ­¥å°±æ…¢æ…¢èƒ½æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ã€‚

é»˜è®¤ nginx æ˜¯è‡ªåŠ¨å¼€å¯ range å¤´çš„, å¦‚æœä¸éœ€è¦é…ç½®ï¼Œåˆ™é…ç½® `max_range: 0;`

Nginx é…ç½®æ–‡æ¡£ http://nginx.org/en/docs/http/ngx_http_core_module.html#max_ranges

## æ€»ç»“

æˆ‘ä»¬å¯ä»¥æ¥æ€»ç»“ä¸€ä¸‹ï¼Œå…¶å®å…¨æ–‡ä¸»è¦è®²äº†(xbb)ä¸¤ä¸ªæ ¸å¿ƒçš„çŸ¥è¯†ï¼Œä¸€ä¸ªæ˜¯ `blob` ä¸€ä¸ª` a` æ ‡ç­¾ï¼Œå¦å¤–è¿˜è¦æ³¨æ„å¯¹äºå¤§æ–‡ä»¶ï¼ŒæœåŠ¡å™¨çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡ `Range` æ¥åˆ†ç‰‡åŠ è½½ã€‚

![image-20200830181216353](https://s3.qiufengh.com/blog/image-20200830181216353.png)

## å‚è€ƒèµ„æ–™

https://github.com/dolanmiu/docx

https://github.com/SheetJS/sheetjs

https://juejin.im/post/6844903763359039501

## æœ€å

å¦‚æœæˆ‘çš„æ–‡ç« æœ‰å¸®åŠ©åˆ°ä½ ï¼Œå¸Œæœ›ä½ ä¹Ÿèƒ½å¸®åŠ©æˆ‘ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å· `ç§‹é£çš„ç¬”è®°`ï¼Œå›å¤`å¥½å‹` äºŒæ¬¡ï¼Œå¯åŠ å¾®ä¿¡å¹¶ä¸”åŠ å…¥äº¤æµç¾¤ï¼Œ`ç§‹é£çš„ç¬”è®°` å°†ä¸€ç›´é™ªä¼´ä½ çš„å·¦å³ã€‚

