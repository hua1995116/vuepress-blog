<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>热更新 HMR | 秋风的笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fd8e413c5ce47d78c95f742fc41a7118";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <meta name="description" content="">
    
    <link rel="preload" href="https://cdn.qiufeng.blue/assets/css/0.styles.29336953.css" as="style"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/app.1a0fcd74.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/3.8063c28d.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/2.bf4393a2.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/128.40b1c8b2.js" as="script"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/10.858c14cb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/100.5b053bd8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/101.c835c4fb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/102.9d2b7727.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/103.0841510d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/104.89ca605c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/105.8c565cdd.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/106.f4d4cacc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/107.c294765a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/108.3257e619.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/109.e17a4df3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/11.3c9e4ba8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/110.6a616322.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/111.651dd1e6.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/112.1f6fb42b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/113.c04e5927.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/114.9a9ae0a1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/115.3b74fbef.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/116.913f1c85.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/117.e75309be.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/118.880cdcc2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/119.44ff47c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/12.5318a2f7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/120.f77e376b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/121.577087f1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/122.7afa626d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/123.e6a1b1e2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/124.775f2803.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/125.f1ca1e26.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/126.e34736f4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/127.e4502464.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/129.b519134c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/13.266d3d2e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/130.c5c23fb1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/131.53f0b101.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/132.ad150809.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/133.36781ad5.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/134.2f50586b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/135.b372261a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/136.af95f5b1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/137.e5e1cc0c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/138.45f6fd87.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/139.bc1ecb45.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/14.9232a82e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/140.5410ede9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/141.b3f0d79e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/142.160d4b80.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/143.27a77db6.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/144.b74dc095.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/145.ee102466.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/146.8bfcae9d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/147.ba4c94bc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/148.cbf5976f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/149.cf79b0c9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/15.22dd741b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/150.bb72c31e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/151.4cd99247.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/152.201a0188.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/153.412aa743.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/154.33d50b3d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/16.1e553702.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/17.64beadba.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/18.1913e4cc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/19.17735d7a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/20.bfdee106.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/21.9d3794cf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/22.00467f6a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/23.2e8b1e6f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/24.f639b010.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/25.4704368b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/26.2973cb16.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/27.d5ffdaa7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/28.2c6f684a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/29.bae4ec1f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/30.935966dc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/31.ff5ad70d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/32.5c054d8a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/33.1d2439a0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/34.1a2ef44e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/35.aa5264c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/36.87e565e1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/37.634fe01c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/38.d9f4d4c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/39.894415fc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/4.51060f90.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/40.f775c381.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/41.a2933617.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/42.f5bfee07.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/43.822f6d09.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/44.fa1d08a4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/45.671db58e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/46.5ff2ec57.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/47.a4b4a0e7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/48.321ce5d7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/49.f22666c6.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/5.dc096b09.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/50.12def055.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/51.e3dd41ac.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/52.f7b480f0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/53.3cc44113.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/54.5b6aab1a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/55.ce041e6e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/56.93aadcaf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/57.19407be7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/58.c20a53e4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/59.77e2aa06.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/6.85f061e1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/60.5153a727.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/61.8e33bde2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/62.29d9668d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/63.737af55f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/64.509bbce7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/65.bace7f5c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/66.48bf86d8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/67.c720195a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/68.bf740811.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/69.6f1f8cbf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/7.959da92e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/70.700af316.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/71.748479ff.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/72.e5be0b4a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/73.e0c47cf3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/74.baf09baf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/75.4bdf3a41.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/76.a21f020a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/77.26ddf3a4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/78.063c2882.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/79.d54889f9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/8.f6bbf435.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/80.81a49c8e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/81.d6f2a896.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/82.6f8bd0c3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/83.2e10f821.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/84.6642661e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/85.421c94ec.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/86.2e20e91c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/87.1e21499f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/88.4fcd6178.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/89.f3b7cfbb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/9.bb436127.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/90.dcc808dc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/91.f59baff0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/92.f38fbaa0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/93.d6bfc60d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/94.f5f030f3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/95.b17d2c48.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/96.fa0a349d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/97.bfa9967a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/98.e66016d8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/99.683783ef.js">
    <link rel="stylesheet" href="https://cdn.qiufeng.blue/assets/css/0.styles.29336953.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">秋风的笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/svelte/" class="nav-link">Svelte系列</a></div><div class="nav-item"><a href="/three/" class="nav-link">Three.js系列</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node系列</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/svelte/" class="nav-link">Svelte系列</a></div><div class="nav-item"><a href="/three/" class="nav-link">Three.js系列</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node系列</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div style="padding-left:1.5rem;"><div class="qr"><img src="https://s3.qiufeng.blue/blog/erweima.jpg" alt="秋风的比较" width="120" height="120" loading="lazy"> <p class="we-intro">
    如果你对前端，Node，开源项目感兴趣请关注我的公众号 <a target="_blank" href="https://mp.weixin.qq.com/s/pKoliWlgtV-qm6orbyTz0Q">秋风的笔记</a>。
  </p></div></div> <!----> </aside> <!----> <!----> <main class="page"><div class="theme-default-content" style="margin-top:3.6rem;padding-top:0;padding-bottom:0;"><div class="bar-container"><div class="bar-intro"><div class="text"><p>阿里云优惠活动，点击链接进行购买: <a href="https://www.aliyun.com/minisite/goods?userCode=qtt5ztpk">一年仅需96.9元即可以购买服务器~ </a></p> <p>腾讯云优惠活动, 点击链接进行购买<a href="https://curl.qcloud.com/mcBHz0hb">一年仅需99元</a></p> <p>腾讯云限时开团活动, 点击链接进行购买<a href="https://cloud.tencent.com/act/cvmgift?hash=K468jiO7GIO6QaYN">一年仅需95元</a></p> <p><a href="/op/service-choice.html">各大服务器厂商对比选购</a></p></div></div></div> <!----></div> <div class="theme-default-content"><div class="content__default"><h1 id="热更新-hmr"><a href="#热更新-hmr" class="header-anchor">#</a> 热更新 HMR</h1> <p>热更新是已经是我们开发中必备的东西了，能够提高我们的开发效率。能够让浏览器不刷新的情况下进行更新内容。其实他的主要原理和 webpack 的 HMR 差不多。但是每个打包器都单独写了不同的接口，使得热更新模块无法共享，为此，snowpack 写了一个关于 ES Module hmr 的规范，https://github.com/pikapkg/esm-hmr 。</p> <p>主要分为 client 和 server 端。</p> <p>我们先从入口开始讲起。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20201008204321155.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20201008204321155"></p> <p>我将 <code>index.js</code>复制了出来。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span>  __SNOWPACK_HMR__ <span class="token keyword">from</span> <span class="token string">'/__snowpack__/hmr.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot <span class="token operator">=</span> __SNOWPACK_HMR__<span class="token punctuation">.</span><span class="token function">createHotContext</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> __SNOWPACK_ENV__ <span class="token keyword">from</span> <span class="token string">'/__snowpack__/env.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env <span class="token operator">=</span> __SNOWPACK_ENV__<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;/web_modules/vue.js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&quot;./App.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Hot Module Replacement (HMR) - Remove this snippet to remove HMR.</span>
<span class="token comment">// Learn more: https://www.snowpack.dev/#hot-module-replacement</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以看到<code>import * as __SNOWPACK_HMR__ from '/__snowpack__/hmr.js';</code>从第一句就可以看到引入了 hmr 模块，并且将 <code>import.meta.url</code> 作为 导入模块的一个方法参数传入。</p> <p>那么这个 <code>import.meta.url</code> 是什么呢 ?</p> <p>https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/import.meta</p> <p>我们来看看 MDN 上的例子来解释。</p> <p><code>import.meta</code>是一个给JavaScript模块暴露特定上下文的元数据属性的对象。它包含了这个模块的信息，比如说这个模块的URL。</p> <p><strong>示例</strong></p> <p>这里有一个 <code>my-module.mjs模块</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>my-module.mjs<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>你可以通过 <code>import.meta</code> 对象获取这个模块的元数据信息.</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { url: &quot;file:///home/user/my-module.mjs&quot; }</span>
</code></pre></div><p>通过以上例子我们知道 <code>import.meta.url</code>就是当前加载 js 的完整url。</p> <p>我们当前的url为 <code>http://localhost:8080/</code>，对应的 <code>index.js</code> 的 <code>import.meta.url</code> 就是 <code>http://localhost:8080/_dist_/index.js</code> 。</p> <p>接着往下看，我们就看到使用了<code>__SNOWPACK_HMR__.createHotContext</code> 赋值给的 <code>import.meta.hot</code>对象。</p> <p>那么我们先来看看 这个 <code>createHotContext</code> 方法都干了什么？</p> <p>https://github.com/pikapkg/snowpack/blob/f1fd2cb181c1fe6ce2f158159a6fc3191e7456b4/snowpack/assets/hmr.js#L83-L94</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hmr.js 83-94</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createHotContext</span><span class="token punctuation">(</span><span class="token parameter">fullUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>fullUrl<span class="token punctuation">)</span><span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
  <span class="token keyword">const</span> existing <span class="token operator">=</span> <span class="token constant">REGISTERED_MODULES</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    existing<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runModuleDispose</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotModuleState</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">REGISTERED_MODULES</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>首先是将传入的<code>import.meta.url</code> 构造了 URL 对象并获取了 <code>pathname</code>，以<code>http://localhost:8080/_dist_/index.js</code>为例，就是获取到了 <code>_dist/_index.js</code>，然后到一个名叫 <code>REGISTERED_MODULES</code> 模块中来查找该模块是否注册，如果注册的话，就会运行一段逻辑。我们目前是未注册的情况，以后再来讲解注册的情况。可以看到如果为注册就到了是 <code>HotModuleState</code> 这个类实例化的过程。然后将它注册到 <code>REGISTERED_MODULES</code>,并返回实例化的对象。</p> <p>继续往下看 <code>HotModuleState</code> 。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">HotModuleState</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isLocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isDeclined <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isAccepted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>acceptCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>disposeCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isLocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>disposeCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">decline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isDeclined <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">accept</span><span class="token punctuation">(</span><span class="token parameter">_deps<span class="token punctuation">,</span> callback <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAccepted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">sendSocketMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">'hotAccept'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isAccepted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>_deps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callback <span class="token operator">=</span> _deps <span class="token operator">||</span> callback<span class="token punctuation">;</span>
      _deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> deps <span class="token operator">=</span> _deps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ext <span class="token operator">=</span> dep<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep <span class="token operator">+=</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ext <span class="token operator">!==</span> <span class="token string">'js'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep <span class="token operator">+=</span> <span class="token string">'.proxy.js'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>origin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>acceptCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      deps<span class="token punctuation">,</span>
      callback<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就这样暴露出了这么一个实例化的对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看到，如果 hmr ，注册成功的话，会先调用 hmr 模块的 <code>accept</code> 方法，然后再调用 <code>dispose</code> 方法，而 dispose 方法中的回调是 vue 实例销毁的方法。那我们就来分析一下 <code>accept</code>  和 <code>dispose</code>方法到底干了什么。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">accept</span><span class="token punctuation">(</span><span class="token parameter">_deps<span class="token punctuation">,</span> callback <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isAccepted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">sendSocketMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">'hotAccept'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isAccepted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>_deps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callback <span class="token operator">=</span> _deps <span class="token operator">||</span> callback<span class="token punctuation">;</span>
      _deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> deps <span class="token operator">=</span> _deps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ext <span class="token operator">=</span> dep<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep <span class="token operator">+=</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ext <span class="token operator">!==</span> <span class="token string">'js'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep <span class="token operator">+=</span> <span class="token string">'.proxy.js'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>origin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>acceptCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      deps<span class="token punctuation">,</span>
      callback<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们的例子中是直接调用了 <code>accept</code>，并且未传入任何的参数，因此看到最后的<code>this.acceptCallbacks.push({deps,callback,});</code> 此处应该为<code>this.acceptCallbacks.push({[],()=&gt;{},});</code> 。</p> <p>再来看看<code>dispose</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>disposeCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法更加简单，就是将我们注册的<code>app.unmoun()</code>的回调函数加入了一个<code>callback</code>队列 。</p> <p>以上就是初始化的所有，看起来并没有什么特别之处。接下来我们来讲一讲，如果是模块热更新后，第二次导入会发生什么？ 我们继续回过头来看 <code>createHotContext</code> 模块。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createHotContext</span><span class="token punctuation">(</span><span class="token parameter">fullUrl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    existing<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">runModuleDispose</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主要逻辑为<code>runModuleDispose(id);</code>，我们接着来看~</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runModuleDispose</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token constant">REGISTERED_MODULES</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>isDeclined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> disposeCallbacks <span class="token operator">=</span> state<span class="token punctuation">.</span>disposeCallbacks<span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>disposeCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  disposeCallbacks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>state</code> 即为上面所说的 <code>HotModuleState</code> 实例化对象，获取 <code>disposeCallbacks</code> 队列，这个就是我们第一次初始化的时候，将回调函数塞入的队列。<code>disposeCallbacks.map((callback) =&gt; callback());</code>最后将队列中的回调函数依次执行。</p> <p>上面描述的有点抽象，下面用途来描述一下主要的流程。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20201009233222226.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20201009233222226"></p> <ol><li>创建了 hmr 的实例</li> <li>创建 app 实例</li> <li>将 app 销毁的回调函数加入到 hmr 销毁队列中</li> <li>app挂载到了实体元素上面</li> <li>文件热更新更后，查询当前文件是否已经已经创建 hmr 实例。</li> <li>执行当前 hmr 实例中的 disposeCallbacks 的回调函数队列。</li> <li>销毁当前实例</li> <li>更新到视图上</li> <li>创建新的实例</li> <li>将新实例app2的回调函数加入到 原 hmr 实例的 disposeCallbacks 队列里</li></ol> <p>之后文件热更新，不断循环 5 - 10。</p> <p>上面我们就讲完了前端部分的热更新，但是我们还没有讲 第一次文件加载以及后面文件改动后的第二次文件加载进行串联，这个就需要后端来进行串联。前端与后端建立websocket通信，后端通知前端去加载对应的文件。那么下面我们来讲讲这个桥梁部分。</p> <p>那我们来看看后端 HMR 模块</p> <p>https://github.com/pikapkg/snowpack/blob/f1fd2cb181c1fe6ce2f158159a6fc3191e7456b4/snowpack/src/hmr-server-engine.ts</p> <p>包含空行一共139行代码。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> WebSocket <span class="token keyword">from</span> <span class="token string">'ws'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> type http <span class="token keyword">from</span> <span class="token string">'http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> type http2 <span class="token keyword">from</span> <span class="token string">'http2'</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">Dependency</span> <span class="token punctuation">{</span>
  dependents<span class="token operator">:</span> Set<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  dependencies<span class="token operator">:</span> Set<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  isHmrEnabled<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  isHmrAccepted<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  needsReplacement<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
  needsReplacementCount<span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">DEFAULT_PORT</span> <span class="token operator">=</span> <span class="token number">12321</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EsmHmrEngine</span> <span class="token punctuation">{</span>
  clients<span class="token operator">:</span> Set<span class="token operator">&lt;</span>WebSocket<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dependencyTree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Dependency<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  wsUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ws://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">DEFAULT_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> <span class="token punctuation">{</span>server<span class="token operator">?</span><span class="token operator">:</span> http<span class="token punctuation">.</span>Server <span class="token operator">|</span> http2<span class="token punctuation">.</span>Http2Server<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构造函数</span>
    <span class="token keyword">const</span> wss <span class="token operator">=</span> options<span class="token punctuation">.</span>server
      <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>noServer<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>port<span class="token operator">:</span> <span class="token constant">DEFAULT_PORT</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'upgrade'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Only handle upgrades to ESM-HMR requests, ignore others.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'sec-websocket-protocol'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'esm-hmr'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        wss<span class="token punctuation">.</span><span class="token function">handleUpgrade</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> head<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          wss<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> client<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 监听连接</span>
    wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListener</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 注册消息事件</span>
  <span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token parameter">client<span class="token operator">:</span> WebSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'hotAccept'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Dependency<span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span>isHmrAccepted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span>isHmrEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">createEntry</span><span class="token punctuation">(</span><span class="token parameter">sourceUrl<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newEntry<span class="token operator">:</span> Dependency <span class="token operator">=</span> <span class="token punctuation">{</span>
      dependencies<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      dependents<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      needsReplacement<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      needsReplacementCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      isHmrEnabled<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isHmrAccepted<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dependencyTree<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> newEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> newEntry<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token parameter">sourceUrl<span class="token operator">:</span> string<span class="token punctuation">,</span> createIfNotFound <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dependencyTree<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>createIfNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createEntry</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 依赖关系处理</span>
  <span class="token function">setEntry</span><span class="token punctuation">(</span><span class="token parameter">sourceUrl<span class="token operator">:</span> string<span class="token punctuation">,</span> imports<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isHmrEnabled <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> outdatedDependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span>isHmrEnabled <span class="token operator">=</span> isHmrEnabled<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importUrl <span class="token keyword">of</span> imports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addRelationship</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      outdatedDependencies<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importUrl <span class="token keyword">of</span> outdatedDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeRelationship</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">removeRelationship</span><span class="token punctuation">(</span><span class="token parameter">sourceUrl<span class="token operator">:</span> string<span class="token punctuation">,</span> importUrl<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> importResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    importResult <span class="token operator">&amp;&amp;</span> importResult<span class="token punctuation">.</span>dependents<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sourceResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sourceResult <span class="token operator">&amp;&amp;</span> sourceResult<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">addRelationship</span><span class="token punctuation">(</span><span class="token parameter">sourceUrl<span class="token operator">:</span> string<span class="token punctuation">,</span> importUrl<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>importUrl <span class="token operator">!==</span> sourceUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> importResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>importUrl<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      importResult<span class="token punctuation">.</span>dependents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sourceResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      sourceResult<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">markEntryForReplacement</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token operator">:</span> Dependency<span class="token punctuation">,</span> state<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      entry<span class="token punctuation">.</span>needsReplacementCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      entry<span class="token punctuation">.</span>needsReplacementCount<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    entry<span class="token punctuation">.</span>needsReplacement <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>entry<span class="token punctuation">.</span>needsReplacementCount<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span>readyState <span class="token operator">===</span> WebSocket<span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnectClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 将连接加入连接池</span>
  <span class="token function">connectClient</span><span class="token punctuation">(</span><span class="token parameter">client<span class="token operator">:</span> WebSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">disconnectClient</span><span class="token punctuation">(</span><span class="token parameter">client<span class="token operator">:</span> WebSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">disconnectAllClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> client <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnectClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码我就详细讲一讲，我把以上主要分为三个部分，第一部分为初始化阶段的连接池，第二部分为消息注册部分，第三部分是依赖处理部分。</p> <p><strong>初始化阶段</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerListener</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token function">connectClient</span><span class="token punctuation">(</span><span class="token parameter">client<span class="token operator">:</span> WebSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>这里我们可以看到，连接的时候是将 client 放入了一个队列，这个是为啥呢？是由于当我们本地开发的时候，会开启多个 tab 页面，或者多个浏览器启动同一个页面，我们的服务都会监听到，当本地代码有改动的时候，所有页面都会自动热更新。怎么样？贴心吧，这个是一个常见的操作，特别是在我们多端设备登录的时候，例如电脑版微信和客户端版本，我们在双端都能收到最新的消息，也就是利用了这个特性。</p> <p><strong>消息注册部分</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
<span class="token function">registerListener</span><span class="token punctuation">(</span><span class="token parameter">client<span class="token operator">:</span> WebSocket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'hotAccept'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Dependency<span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span>isHmrAccepted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span>isHmrEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>为什么我把这部分单独拎出来讲呢？这部分其实很简单，就是注册了一个<code>messages</code> 事件，等待客户端发送信息给服务端，但是这里也涉及到了一个部分 <code>message.type === 'hotAccept'</code> 当这个条件成立的时候，会去影响到我们的第三个部分，这里我们只需要注意一下就行，后面会详细讲到。</p> <div class="language-js extra-class"><pre class="language-js"><code>entry<span class="token punctuation">.</span>isHmrAccepted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
entry<span class="token punctuation">.</span>isHmrEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><p>这两个是特殊标志。</p> <p><strong>依赖处理部分</strong></p> <p>这个部分也是热更新最重要的部分，决定着热更新的更新范围。你可能会比较懵，热更新又设计依赖收集了呢？不急先听我道来。</p> <p>例如我们有以下结构</p> <div class="language- extra-class"><pre class="language-text"><code>./
├── index.js
└── src
    ├── a.js
    └── b.js
</code></pre></div><p><code>index.js</code> 引入<code>a.js</code> ,<code>a.js</code> 引入<code>b.js</code> 。</p> <p>这个时候我们修改 <code>b.js</code> ，如果我们不依赖分析，那么我们会一股脑儿去刷新 <code>index.js</code> ，因为只要<code>index.js</code>重新载入 ，那么我们 <code>a.js</code> 和 <code>b.js</code> 也会被重新导入，从而达到 <code>b.js</code> 也更新的效果。</p> <p>而我们有时候期望更新点达到最小化，<code>b.js</code> 更新，我不期望整个应用去更新。我们只需要找到 <code>b.js</code> 从属的 <code>a.js</code> 更新就好了。</p> <p>以下用图形化来解释，b.js 更新冒泡到 index.js 是我们所不期望。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20201011165628322.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20201011165628322"></p> <p>而<code>b.js</code> 的修改冒泡到 <code>a.js</code> 是我们所期望的。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20201011165727732.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20201011165727732"></p> <p>而<code>b.js</code> 冒泡到 <code>a.js</code>是我们所期望的。</p> <p>以上我们讲清楚了，为什么需要这个第三部分。</p> <p>那么我们来讲讲这个第三部分依赖关系是怎么样的。</p> <p>由于这个依赖关系的调用是在构建阶段，因此我们这边不会去讲构建阶段相关信息。我们就单从这几个函数来进行推测模拟。我们可以将<code>createEntry</code>,<code>getEntry</code>,<code>setEntry</code>,<code>removeRelationship</code>,<code>addRelationship</code>这些依赖相关的函数都搜一下，最终我们会发现源头来源于 <code>setEntry</code>,因此我们就可以把这个函数当做入口。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setEntry</span><span class="token punctuation">(</span><span class="token parameter">sourceUrl<span class="token operator">:</span> string<span class="token punctuation">,</span> imports<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> isHmrEnabled <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> outdatedDependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span>isHmrEnabled <span class="token operator">=</span> isHmrEnabled<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importUrl <span class="token keyword">of</span> imports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addRelationship</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
      outdatedDependencies<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importUrl <span class="token keyword">of</span> outdatedDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeRelationship</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了方便理解，我们会用例子带着来理解，还记得一开始的例子吗。将上述代码经过解析就是如下模样。</p> <div class="language- extra-class"><pre class="language-text"><code>sourceUrl: /_dist_/index.js
imports: [ '/__snowpack__/hmr.js',
  '/__snowpack__/env.js',
  '/web_modules/vue.js',
  '/_dist_/App.js' ]
isHmrEnabled: true
</code></pre></div><p>这样理解起来是不是非常的容易呢？源码为什么难懂，只是因为源码代码量太大，我们没办法一下记住那么多个变量以及流程。如果我们肉眼直接能看出某些变化，那源码阅读就很简单了。好了我们接着讲。</p> <p>首先是通过 <code>this.getEntry</code> 去获取当前路径资源的依赖实例，如果没有找到则会去创建一个实例。依赖实例初始化长这个样子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> newEntry<span class="token operator">:</span> Dependency <span class="token operator">=</span> <span class="token punctuation">{</span>
      dependencies<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      dependents<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      needsReplacement<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      needsReplacementCount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      isHmrEnabled<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isHmrAccepted<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来就会会遍历 <code>imports</code> 建立依赖关系。</p> <p>这个时候我们会发现有这么个步骤</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> outdatedDependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
result<span class="token punctuation">.</span>isHmrEnabled <span class="token operator">=</span> isHmrEnabled<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importUrl <span class="token keyword">of</span> imports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addRelationship</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  outdatedDependencies<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> importUrl <span class="token keyword">of</span> outdatedDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeRelationship</span><span class="token punctuation">(</span>sourceUrl<span class="token punctuation">,</span> importUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个是在做什么呢。这里主要是讲老的依赖进行删除，然后增加新的依赖，类似于一个简版 <code>diff</code>。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20201011192628620.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20201011192628620"></p> <p>例如我们的 <code>index.js</code> 旧的依赖的是</p> <div class="language- extra-class"><pre class="language-text"><code>[ '/__snowpack__/hmr.js',
  '/__snowpack__/env.js',
  '/web_modules/vue.js',
  '/_dist_/App.js' ]
</code></pre></div><p>新的依赖为</p> <div class="language- extra-class"><pre class="language-text"><code>[ '/__snowpack__/env.js',
  '/web_modules/vue.js',
  '/_dist_/Demo.js' ]
</code></pre></div><p>那么就会加入 <code>'/_dist_/Demo.js'</code> 删减 <code>'/__snowpack__/hmr.js'</code>、<code>'/_dist_/App.js'</code>。</p> <p>我们已经和前端建立了联系，那么，什么时候去发送消息呢？这个时候我们就要来看看，我们的文件监听模块。</p> <p>https://github.com/pikapkg/snowpack/blob/f1fd2cb181c1fe6ce2f158159a6fc3191e7456b4/snowpack/src/commands/dev.ts#L901</p> <p><code>const chokidar = await import('chokidar');</code>作者主要用来了 <code>chokidar</code> 来进行监听本地文件的改动。这个库能够高性能地去使用文件监听。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20201011194330922.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20201011194330922"></p> <p>像 <code>VS Code</code>、<code>gulp</code>、<code>karma</code>、<code>pm2</code>、<code>webpack</code> 监听文件改动也是使用了这个库。</p> <div class="language-js extra-class"><pre class="language-js"><code>	<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">onWatchEvent</span><span class="token punctuation">(</span><span class="token parameter">fileLoc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'File changed...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleHmrUpdate</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inMemoryBuildCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    filesBeingDeleted<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> cacache<span class="token punctuation">.</span>rm<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token constant">BUILD_CACHE</span><span class="token punctuation">,</span> fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    filesBeingDeleted<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> watcher <span class="token operator">=</span> chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>
    mountedDirectories<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>dirDisk<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> dirDisk<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      ignored<span class="token operator">:</span> config<span class="token punctuation">.</span>exclude<span class="token punctuation">,</span>
      persistent<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      ignoreInitial<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      disableGlobbing<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fileLoc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onWatchEvent</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fileLoc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onWatchEvent</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unlink'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fileLoc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onWatchEvent</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果文件改动了、增加、删除，都会触发 <code>onWatchEvent</code> 这个事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">onWatchEvent</span><span class="token punctuation">(</span><span class="token parameter">fileLoc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>colors<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'File changed...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleHmrUpdate</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inMemoryBuildCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    filesBeingDeleted<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> cacache<span class="token punctuation">.</span>rm<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token constant">BUILD_CACHE</span><span class="token punctuation">,</span> fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    filesBeingDeleted<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们先来看看<code>handleHmrUpdate</code> 这个函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleHmrUpdate</span><span class="token punctuation">(</span><span class="token parameter">fileLoc<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isLiveReloadPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> updateUrl <span class="token operator">=</span> <span class="token function">getUrlFromFile</span><span class="token punctuation">(</span>mountedDirectories<span class="token punctuation">,</span> fileLoc<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>updateUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Append &quot;.proxy.js&quot; to Non-JS files to match their registered URL in the client app.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>updateUrl<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      updateUrl <span class="token operator">+=</span> <span class="token string">'.proxy.js'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Check if a virtual file exists in the resource cache (ex: CSS from a Svelte file)</span>
    <span class="token comment">// If it does, mark it for HMR replacement but DONT trigger a separate HMR update event.</span>
    <span class="token comment">// This is because a virtual resource doesn't actually exist on disk, so we need the main</span>
    <span class="token comment">// resource (the JS) to load first. Only after that happens will the CSS exist.</span>
  <span class="token comment">// 检查资源缓存中是否存在一个虚拟文件（例如：来自Svelte文件的CSS），如果存在，将其标记为HMR替换，但不要触发一个单独的HMR更新事件。资源（JS）先加载。只有在这之后，CSS才会存在。</span>
  <span class="token comment">// 为什么呢？因为资源只有在请求 .vue 这样的文件找到后，才会进行构建生成新的 css。</span>

    <span class="token keyword">const</span> virtualCssFileUrl <span class="token operator">=</span> updateUrl<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">'.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> virtualNode <span class="token operator">=</span> hmrEngine<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>virtualCssFileUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.proxy.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hmrEngine<span class="token punctuation">.</span><span class="token function">markEntryForReplacement</span><span class="token punctuation">(</span>virtualNode<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If the changed file exists on the page, trigger a new HMR update.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hmrEngine<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span>updateUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">updateOrBubblejs</span><span class="token punctuation">(</span>updateUrl<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   	<span class="token keyword">if</span> <span class="token punctuation">(</span>inMemoryBuildCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hmrEngine<span class="token punctuation">.</span><span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'reload'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中又涉及到 <code>getUrlFromFile</code> ,这个函数的作用是，将本地的文件，映射到网络的 url 。例如 本地 <code>src/App.vue</code> 映射到 <code>_dist_/App.js</code>。然后接下来步骤是尝试看看当前路径是否为虚拟文件（所谓虚拟文件就是不实际存在，是一种 hack 的形式，例如 ES Modules 无法直接导入 css 等文件）。如果是虚拟文件的话，作一个标记，等下载虚拟文件的承载实体请求到的时候，再进行更新。如果不是上述情况，那么继续运行下面的步骤，如果在热更新模块中能找到当前的构建 url，则调用 <code>updateOrBubblejs</code> 。</p> <p>这个函数就和它的字面意思一样，会往上冒泡，如果当前模块没有注册热更新模块，那么该模块会往上找他的父级，如果父级找不到就会找爷爷级。那么为什么会有这样的冒泡呢？原因我们在说热更新依赖的时候说了，最小化就近更新原则。如果找不到的话会调用 <code>hmrEngine.broadcastMessage({type: 'reload'});</code>， 就是刷新整个页面。<code>handleHmrUpdate</code> 函数最后也是如此，也会调用 <code>hmrEngine.broadcastMessage({type: 'reload'});</code></p> <p>最后清空当前文件的缓存，能够让下次请求的时候重新构建，而不是寻找缓存模块。</p> <div class="language-js extra-class"><pre class="language-js"><code>inMemoryBuildCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
filesBeingDeleted<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> cacache<span class="token punctuation">.</span>rm<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token constant">BUILD_CACHE</span><span class="token punctuation">,</span> fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
filesBeingDeleted<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fileLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>至此热更新的所有模块都讲完了。</p> <p>前端  -&gt;  后端   -&gt;  文件改动  -&gt; 后端监听 -&gt; 通知前端</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/8/2021, 1:38:24 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="https://cdn.qiufeng.blue/assets/js/app.1a0fcd74.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/3.8063c28d.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/2.bf4393a2.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/128.40b1c8b2.js" defer></script>
  </body>
</html>
