<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息未读之点不完的小红点(Node+Websocket) | 个人技能知识分享</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fd8e413c5ce47d78c95f742fc41a7118";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <meta name="description" content="">
    
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/css/0.styles.865202d5.css" as="style"><link rel="preload" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/app.fe2bb2a6.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/3.edcda278.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/2.bf4393a2.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/97.da739e4a.js" as="script"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/10.07a30cff.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/100.3b64e8b2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/101.b1cdc614.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/102.a3fb430b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/103.d4551c4f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/104.71f7e365.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/105.42400b7b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/106.b2c2fb4d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/107.ec5c3030.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/108.73a91adb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/109.52b9801d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/11.1000d380.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/110.6402d4bf.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/111.5e98fd65.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/112.3bf08bfc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/113.125ed226.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/114.8b1e3c3c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/115.b1e35fb5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/116.6d507435.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/117.7ac261a6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/118.c5938fdd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/119.9e26f459.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/12.dde1a8da.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/120.a8960b83.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/121.21ae9ac7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/122.2cdec291.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/123.c49327f4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/124.a7b0faa6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/125.e520d0c7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/126.21fef0a6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/127.e142391a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/128.8ba46138.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/129.9eab1120.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/13.22602e21.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/130.d2424de5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/131.84dbdbfe.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/132.d4fe55fc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/133.6e67a216.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/134.ccdc6416.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/135.35e095b2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/136.8426f41e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/137.9fbb22c5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/138.a1a1d2b4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/139.ee5aa5f2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/14.8a4f5c49.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/140.f5a9c208.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/15.6841fa79.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/16.30bd8442.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/17.367894a5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/18.b4d1ec3c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/19.61332280.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/20.3ad63cb8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/21.85989bdc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/22.4ade9f8f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/23.05784e9e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/24.68d9f20f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/25.76da1fe1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/26.e7c96028.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/27.75bbefa3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/28.6330253c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/29.c2af5063.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/30.22327e16.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/31.8c4fdcaa.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/32.fe3e5a92.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/33.37f259d3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/34.ed6f5081.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/35.00f626ce.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/36.17f315d0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/37.bffc3eca.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/38.e358df6d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/39.b3069b4a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/4.3741ad8b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/40.4ab45744.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/41.bedb6cbc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/42.ab5daf7c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/43.e2675fb2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/44.060fb66a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/45.7ba328a6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/46.28011577.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/47.f7145e9b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/48.84b7292c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/49.9bb6c4f7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/5.dc096b09.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/50.689e142b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/51.b02fe510.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/52.0f469d87.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/53.395edfd3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/54.bfd613b9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/55.d28aec37.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/56.cc145755.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/57.55025bd7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/58.d9f15ad2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/59.a0872ccc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/6.e62b8c8b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/60.9ef620a8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/61.57281ae3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/62.34f15b7e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/63.c88dbba7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/64.17c5143b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/65.e7927590.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/66.7b443e73.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/67.0ed92abd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/68.5d991968.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/69.5a7c975e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/7.5cceb66b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/70.ac2f587d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/71.0271405e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/72.ecd33812.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/73.018d80ef.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/74.5dc38e35.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/75.cde8f369.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/76.a206148d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/77.3abb0080.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/78.405ec760.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/79.69b685f8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/8.127e672d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/80.fdfa16f3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/81.1d766b0c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/82.1f9054ba.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/83.b1f498dd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/84.380ce329.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/85.9d19c978.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/86.76fa158f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/87.0a51cbb9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/88.09ce9094.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/89.8a39470c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/9.4e32b08f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/90.df9dac54.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/91.5fff1072.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/92.105f9fdd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/93.1a397258.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/94.d9b051c7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/95.a5a5d053.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/96.06f3dd99.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/98.e6c68dde.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/99.a65f86a0.js">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/css/0.styles.865202d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人技能知识分享</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">Node 实践</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">我的开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">Node 实践</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">我的开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div style="padding-left:1.5rem;"><div class="qr"><img src="https://s3.qiufeng.blue/blog/erweima.jpg" alt="秋风的比较" width="120" height="120" loading="lazy"> <p class="we-intro">
    如果你对前端，Node，开源项目感兴趣请关注我的公众号<span class="we-highlight">秋风的笔记</span>。
  </p></div></div> <ul class="sidebar-links"><li><a href="/node/mutiple-download.html" class="sidebar-link">前端多线程大文件下载实践，提速10倍+</a></li><li><a href="/node/file-download.html" class="sidebar-link">一文带你层层解锁「文件下载」的奥秘</a></li><li><a href="/node/upload.html" class="sidebar-link"> 一文了解文件上传全过程（1.8w字深度解析，进阶必备）</a></li><li><a href="/node/color.html" class="sidebar-link"> 让浏览器添上终端的彩</a></li><li><a href="/node/crawler.html" class="sidebar-link"> 手把手教你多页面递归爬虫--基于Node.Js</a></li><li><a href="/node/node-addon.html" class="sidebar-link"> Node + NAPI 实现 C++ 扩展 - LRU 淘汰算法</a></li><li><a href="/node/node-cli-count.html" class="sidebar-link"> 开发一个Node小玩具全过程</a></li><li><a href="/node/node-git-down.html" class="sidebar-link"> 对症下药，快速下载github单个文件夹</a></li><li><a href="/node/pkg.html" class="sidebar-link"> pkg版本规范管理自动化最佳实践</a></li><li><a href="/node/shark-cleaner.html" class="sidebar-link"> shark-cleaner: 一个Node Cli 实现的垃圾清理工具(深层清理开发垃圾)</a></li><li><a href="/node/translate.html" class="sidebar-link"> 一个免费功能强大的谷歌翻译api</a></li></ul> </aside> <!----> <!----> <main class="page"><div class="theme-default-content" style="margin-top:3.6rem;padding-top:0;padding-bottom:0;"><div class="bar-container"><div class="bar-intro"><div class="text"><p>阿里云优惠活动，点击链接进行购买: <a href="https://www.aliyun.com/minisite/goods?userCode=qtt5ztpk">一年仅需96.9元即可以购买服务器~ </a></p> <p>腾讯云优惠活动, 点击链接进行购买<a href="https://curl.qcloud.com/mcBHz0hb">一年仅需99元</a></p> <p>腾讯云限时开团活动, 点击链接进行购买<a href="https://cloud.tencent.com/act/cvmgift?hash=K468jiO7GIO6QaYN">一年仅需95元</a></p> <p><a href="/op/service-choice.html">各大服务器厂商对比选购</a></p></div></div></div> <!----></div> <div class="theme-default-content"><div class="content__default"><h1 id="消息未读之点不完的小红点-node-websocket"><a href="#消息未读之点不完的小红点-node-websocket" class="header-anchor">#</a> 消息未读之点不完的小红点(Node+Websocket)</h1> <h1 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h1> <p>https://github.com/hua1995116/webchat</p> <p>这个项目本来是我学生时代为了找工作的一个练手项目，但是没想到受到了很多的关注，star也快要破K了，这也激励着我不断去完善他，一方面是得对得起关注学习的人，另一方面也是想让自己能过通过慢慢完善一个项目来让自己提高。</p> <p><img src="https://s3.qiufeng.blue/blog/1568533450654.jpg" alt=""></p> <p>今天给大家带来的是基于Websocket+Node+Redis未读消息功能，可能更加偏向于实战方向，需要对Websocket和Node有一些了解，当然不了解也可以看看效果，效果链接（ https://www.qiufengh.com/ ）说不定会激起你学习的动力~</p> <p>下面我通过自己思考的方式来进行讲解，代码可能讲的不多，但是核心逻辑都进行了讲解，上面也有github地址，有兴趣的可以进行详细地查看。自己的idea或多或少会有一些不成熟，但是我还是厚着脸皮出来抛头露脸，如果有什么建议还请大家多多提出，能让我更加完善这个作品。</p> <h1 id="设计"><a href="#设计" class="header-anchor">#</a> 设计</h1> <p>首先对于消息未读，大家都很熟悉，就是各种聊天的时候，出现的红点点，且是强迫症者必须清理的一个小点点，如👇所示。我会带大家实现一个这样的功能。
<img src="https://s3.qiufeng.blue/blog/1568533450630.jpg" alt=""></p> <p>由于一对一的方式更加简单，我现在只考虑多对多的情况，也就是在一个房间（也可以称为群组，后面都以房间称呼）中的未读消息，那么设计这样的一个功能，首相我将它分成了3种用户。</p> <ul><li>离线用户</li> <li>在线用户</li> <li>在线用户且进入群组的用户</li></ul> <h3 id="离线用户"><a href="#离线用户" class="header-anchor">#</a> 离线用户</h3> <p>这种场景就相当于我们退出微信，但是别人在房间里发的消息，当我们再次打开的时候依然能够看到房间增长的未读消息。</p> <h3 id="在线用户"><a href="#在线用户" class="header-anchor">#</a> 在线用户</h3> <p>这种场景就是相当我们停留在聊天列表页面，当他人在房间中发送消息，我们能够实时的看到未读消息的条数在增长。</p> <p>场景示例。
<img src="https://user-gold-cdn.xitu.io/2018/11/19/16729eb68b18a543?w=2000&amp;h=2000&amp;f=png&amp;s=231925" style="width:500px;text-align:center;"></p> <h3 id="在线用户且在房间的用户"><a href="#在线用户且在房间的用户" class="header-anchor">#</a> 在线用户且在房间的用户</h3> <p>这种场景其实就比较普通了，当别人发送新的消息，我们就能实时看到，此时是不需要标记未读消息的。</p> <p>场景示例。
<img src="https://user-gold-cdn.xitu.io/2018/11/19/16729ebe4cc2ff41?w=2000&amp;h=2000&amp;f=png&amp;s=500000" style="width:500px;text-align:center;"></p> <h1 id="流程图"><a href="#流程图" class="header-anchor">#</a> 流程图</h1> <p>主要流程可以简化为三个部分，分别为用户，推送功能，消息队列。</p> <p>用户可以是消息提供者也可以是消息接受者。以下就是这个过程。
<img src="https://s3.qiufeng.blue/blog/1568533450629.png" alt="image"></p> <p>当然在这个过程中涉及比较复杂的消息的存储，如何推送，获取，同步等问题，下面就是对这个过程进行详细的描述</p> <p><img src="https://s3.qiufeng.blue/blog/1568533450696.png" alt="image"></p> <p><strong>图上的流程解释</strong></p> <p>A. 存储在Node缓存中的房间用户列表（此处信息也可以存在Redis中）</p> <p>B. 存储在Redis中的未读消息列表</p> <p>C. 存储在MongoDB中的未读消息列表</p> <ol><li>用户1进入首页。</li> <li>用户1进入房间，重置用户在房间1的未读消息，触发更新模块去更新B未读消息列表。</li> <li>用户1向向房间B中发送了一条消息。</li> <li>后端需要去获取房间用户列表，判断用户是否在房间？</li> <li>是，因为在房间中的用户已经读取了最新消息，不需要进行计数。</li> <li>否，若用户不在房间中，更新其的未读消息计数</li> <li>从缓存中获取用户的消息进行分发。</li> <li>用户2登录我们的项目，从离线用户变成了在线用户。</li> <li>用户2登录时，触发查询模块，去获取其当前在各个房间未读消息情况。</li> <li>查询模块去查询Redis中的未读消息，若Redis中没有数据，会继续向数据库中查询，若没有则返回0给用户。</li> <li>Redis缓存将会每分钟和数据库同步一次，保证数据的持久化。</li></ol> <h1 id="环境"><a href="#环境" class="header-anchor">#</a> 环境</h1> <ul><li><p>Node: 8.5.0 +</p></li> <li><p>Npm: 5.3.0 +</p></li> <li><p>MongoDB</p></li> <li><p>Redis</p></li></ul> <h2 id="为什么是redis"><a href="#为什么是redis" class="header-anchor">#</a> 为什么是redis ？</h2> <h3 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h3> <p>Redis 是互联网技术领域使用最为广泛的存储中间件，它是「Remote Dictionary Service」的首字母缩写，是一个高性能的key-value数据库。具有性能极高，丰富的数据类型，原子，丰富的特性等优势。</p> <p>redis 具有以下5种数据结构</p> <ul><li>String——字符串</li> <li>Hash——字典</li> <li>List——列表</li> <li>Set——集合</li> <li>Sorted Set——有序集合</li></ul> <p>想要深入了解这5种存储结构可以查看<a href="http://www.runoob.com/w3cnote/redis-use-scene.html" target="_blank" rel="noopener noreferrer">http://www.runoob.com/w3cnote/redis-use-scene.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p><strong>windows</strong></p> <blockquote><p>http://www.cnblogs.com/jaign/articles/7920588.html</p></blockquote> <p><strong>mac</strong></p> <blockquote><p>brew install redis</p></blockquote> <p><strong>ubuntu</strong></p> <blockquote><p>apt-get install redis</p></blockquote> <p><strong>redhat</strong></p> <blockquote><p>yum install redis</p></blockquote> <p><strong>centos</strong></p> <blockquote><p>https://www.cnblogs.com/zuidongfeng/p/8032505.html</p></blockquote> <p><strong>运行客户端</strong></p> <blockquote><p>redis-cli</p></blockquote> <h3 id="可视化工具安装"><a href="#可视化工具安装" class="header-anchor">#</a> 可视化工具安装</h3> <p><strong>windows</strong></p> <blockquote><p>https://pan.baidu.com/s/1kU8sY3P</p></blockquote> <p><strong>mac</strong></p> <blockquote><p>https://pan.baidu.com/s/10vpdhw7YfDD7G4yZCGtqQg</p></blockquote> <p><strong>源码编译</strong></p> <blockquote><p>http://docs.redisdesktop.com/en/latest/install/#build-from-source</p></blockquote> <h3 id="项目中的数据结构"><a href="#项目中的数据结构" class="header-anchor">#</a> 项目中的数据结构</h3> <p>在本项目中我们用String 来存储用户的未读消息记录，利用其incr命令来进行自增操作。利用Hash结构 来存储我们websocket连接时用户的socket-id。</p> <p>上面说了计数利用Redis的Stirng数据结构,
在Redis 我们的计数key-value是这样的。</p> <p>username-roomid - number</p> <p>例子: hua1995116-room1 - 1</p> <p>我们的Socket-id则为Hash结构。</p> <ul><li>socketId
<ul><li>username - socketid</li></ul></li></ul> <p>例子:</p> <ul><li>socketId
<ul><li>hua1995116 - En4ilYqDpk-P5_tzAAAG</li></ul></li></ul> <h1 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> MongoDB</h1> <p>本项目一开始就使用了MongoDB，Node天然搭配的MongoDB的优势，这里就不再进行讲解，Node操作MongoDB的模块叫做mongoose，具体的参数方法，可以查看官方文档。</p> <p><a href="https://mongoosejs.com/docs/4.x/index.html" target="_blank" rel="noopener noreferrer">https://mongoosejs.com/docs/4.x/index.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>MongoDB下载地址</p> <p>https://www.mongodb.com/download-center/community</p> <p>可视化下载地址</p> <p>https://github.com/mrvautin/adminMongo</p> <h1 id="websocket-node-实现"><a href="#websocket-node-实现" class="header-anchor">#</a> websocket + node 实现</h1> <p>下面我们通过一开始的3种用户的场景来具体说明实现的代码。</p> <h3 id="离线用户变成在线用户"><a href="#离线用户变成在线用户" class="header-anchor">#</a> 离线用户变成在线用户</h3> <p><img src="https://s3.qiufeng.blue/blog/1568533450632.png" alt="image"></p> <p>客户端在登录时会发送一个login事件，以下是后端逻辑。</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 建立连接</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'socket login!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    socket<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> roomInfo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化socketId</span>
    <span class="token keyword">await</span> <span class="token function">updatehCache</span><span class="token punctuation">(</span><span class="token string">'socketId'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> roomList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> roomid <span class="token operator">=</span> roomList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>roomid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token comment">// 循环所有房间</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token operator">:</span> key<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCacheById</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
      <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 数据库查数据， 若缓存中没有数据，更新缓存</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">+</span>count <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">updateCache</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> res<span class="token punctuation">.</span>roomInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        roomInfo<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>roomInfo<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        roomInfo<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">+</span>count<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 通知自己有多少条未读消息</span>
    socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> roomInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>用户从离线变成在线状态，建立socket连接时候，会发送一个login事件, 服务端就会去查询当前用户的未读消息情况，从MongoDB和Redis分别查询，若Redis中没有数据，则像数据库查询。</p> <h3 id="在线用户进入房间"><a href="#在线用户进入房间" class="header-anchor">#</a> 在线用户进入房间</h3> <p><img src="https://s3.qiufeng.blue/blog/1568533451348.png" alt="image"></p> <p>客户端在加入房间说话会发送一个room事件，以下是后端逻辑</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 加入房间</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'room'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'socket add room!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span> roomid<span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span>roomid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    socket<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span>roomid <span class="token operator">=</span> roomid<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>users<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      users<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 初始化user</span>
    users<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      socketid<span class="token operator">:</span> socket<span class="token punctuation">.</span>id
    <span class="token punctuation">}</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    
    <span class="token comment">// 初始化user</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>roomid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">updatehCache</span><span class="token punctuation">(</span><span class="token string">'socketId'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 进入房间默认置空，表示全部已读</span>
    <span class="token keyword">await</span> <span class="token function">resetCacheById</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 进行会话</span>
    socket<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>roomid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> onlineUsers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> item <span class="token keyword">in</span> users<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      onlineUsers<span class="token punctuation">[</span>item<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      onlineUsers<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> users<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span><span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    io<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>roomid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'room'</span><span class="token punctuation">,</span> onlineUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    global<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 加入了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>roomid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>服务端接收到客户端发送的room事件，来重置该用户房间内的未读消息，并且该用户加入房间列表。</p> <h3 id="在房间中的用户发送消息"><a href="#在房间中的用户发送消息" class="header-anchor">#</a> 在房间中的用户发送消息</h3> <p><img src="https://s3.qiufeng.blue/blog/1568533450721.png" alt="image"></p> <p>客户端在加入房间说话会发送一个message事件，以下是后端逻辑</p> <div class="language-Javascript extra-class"><pre class="language-javascript"><code>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">msgObj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'socket message!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">//向所有客户端广播发布的消息</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> src<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> img<span class="token punctuation">,</span> roomid<span class="token punctuation">,</span> time<span class="token punctuation">}</span> <span class="token operator">=</span> msgObj<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>msg <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>img<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span> <span class="token comment">// 此处为向数据库存入消息</span>
    <span class="token keyword">const</span> usersList <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">gethAllCache</span><span class="token punctuation">(</span><span class="token string">'socketId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 所有用户列表</span>
    usersList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>users<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span><span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 判断是否在房间内</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>roomid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">await</span> <span class="token function">inrcCache</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> socketid <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">gethCacheById</span><span class="token punctuation">(</span><span class="token string">'socketId'</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCacheById</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> roomInfo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        roomInfo<span class="token punctuation">[</span>roomid<span class="token punctuation">]</span> <span class="token operator">=</span> count<span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>socketid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> roomInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre></div><p>此步骤略微复杂，主要是房间中的用户发送消息，需要经过判断，哪部分用户需要计数，哪部分用户不需要计数，从图中可以看出，不在房间内的用户都需要计数。</p> <p>接下来还需要推送，那么哪些用户需要实时地推送呢，对的，就是那些在线用户并且不在房间内的用户。因此在这里也需要一个判断。</p> <p>这样就完美了，能够精确地给用户增加计数，并且精确地推送给需要的用户。</p> <h1 id="后记"><a href="#后记" class="header-anchor">#</a> 后记</h1> <p>在线演示: https://www.qiufengh.com/</p> <p>github地址: https://github.com/hua1995116/webchat</p> <p>如果有什么建议或者疑问可以加入微信群进行探讨。</p> <p style="text-align:center;"><img src="https://user-gold-cdn.xitu.io/2018/11/19/16729ed23f9be3a2?w=674&amp;h=896&amp;f=jpeg&amp;s=64232" style="width:300px;"></p> <h1 id="更多请关注"><a href="#更多请关注" class="header-anchor">#</a> 更多请关注</h1> <p><img src="https://s3.qiufeng.blue/blog/gongzhonghao.png" alt=""></p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/3/2021, 11:43:11 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/app.fe2bb2a6.js" defer></script><script src="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/3.edcda278.js" defer></script><script src="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/2.bf4393a2.js" defer></script><script src="https://cdn.jsdelivr.net/gh/hua1995116/vuepress-blog@master/docs/.vuepress/dist/assets/js/97.da739e4a.js" defer></script>
  </body>
</html>
