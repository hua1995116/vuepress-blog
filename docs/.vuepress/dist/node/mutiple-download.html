<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端多线程大文件下载实践，提速10倍+ | 秋风的笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fd8e413c5ce47d78c95f742fc41a7118";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <meta name="description" content="浏览器实现大文件多线程下载，利用Range多线程下载">
    <meta name="keywords" content="Range 多线程 Node 浏览器">
    
    <link rel="preload" href="https://cdn.qiufeng.blue/assets/css/0.styles.29336953.css" as="style"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/app.1a0fcd74.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/3.8063c28d.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/2.bf4393a2.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/87.1e21499f.js" as="script"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/10.858c14cb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/100.5b053bd8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/101.c835c4fb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/102.9d2b7727.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/103.0841510d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/104.89ca605c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/105.8c565cdd.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/106.f4d4cacc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/107.c294765a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/108.3257e619.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/109.e17a4df3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/11.3c9e4ba8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/110.6a616322.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/111.651dd1e6.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/112.1f6fb42b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/113.c04e5927.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/114.9a9ae0a1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/115.3b74fbef.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/116.913f1c85.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/117.e75309be.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/118.880cdcc2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/119.44ff47c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/12.5318a2f7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/120.f77e376b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/121.577087f1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/122.7afa626d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/123.e6a1b1e2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/124.775f2803.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/125.f1ca1e26.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/126.e34736f4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/127.e4502464.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/128.40b1c8b2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/129.b519134c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/13.266d3d2e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/130.c5c23fb1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/131.53f0b101.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/132.ad150809.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/133.36781ad5.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/134.2f50586b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/135.b372261a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/136.af95f5b1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/137.e5e1cc0c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/138.45f6fd87.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/139.bc1ecb45.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/14.9232a82e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/140.5410ede9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/141.b3f0d79e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/142.160d4b80.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/143.27a77db6.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/144.b74dc095.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/145.ee102466.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/146.8bfcae9d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/147.ba4c94bc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/148.cbf5976f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/149.cf79b0c9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/15.22dd741b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/150.bb72c31e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/151.4cd99247.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/152.201a0188.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/153.412aa743.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/154.33d50b3d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/16.1e553702.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/17.64beadba.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/18.1913e4cc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/19.17735d7a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/20.bfdee106.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/21.9d3794cf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/22.00467f6a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/23.2e8b1e6f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/24.f639b010.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/25.4704368b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/26.2973cb16.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/27.d5ffdaa7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/28.2c6f684a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/29.bae4ec1f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/30.935966dc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/31.ff5ad70d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/32.5c054d8a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/33.1d2439a0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/34.1a2ef44e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/35.aa5264c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/36.87e565e1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/37.634fe01c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/38.d9f4d4c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/39.894415fc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/4.51060f90.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/40.f775c381.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/41.a2933617.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/42.f5bfee07.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/43.822f6d09.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/44.fa1d08a4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/45.671db58e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/46.5ff2ec57.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/47.a4b4a0e7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/48.321ce5d7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/49.f22666c6.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/5.dc096b09.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/50.12def055.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/51.e3dd41ac.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/52.f7b480f0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/53.3cc44113.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/54.5b6aab1a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/55.ce041e6e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/56.93aadcaf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/57.19407be7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/58.c20a53e4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/59.77e2aa06.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/6.85f061e1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/60.5153a727.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/61.8e33bde2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/62.29d9668d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/63.737af55f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/64.509bbce7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/65.bace7f5c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/66.48bf86d8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/67.c720195a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/68.bf740811.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/69.6f1f8cbf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/7.959da92e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/70.700af316.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/71.748479ff.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/72.e5be0b4a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/73.e0c47cf3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/74.baf09baf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/75.4bdf3a41.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/76.a21f020a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/77.26ddf3a4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/78.063c2882.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/79.d54889f9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/8.f6bbf435.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/80.81a49c8e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/81.d6f2a896.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/82.6f8bd0c3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/83.2e10f821.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/84.6642661e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/85.421c94ec.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/86.2e20e91c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/88.4fcd6178.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/89.f3b7cfbb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/9.bb436127.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/90.dcc808dc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/91.f59baff0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/92.f38fbaa0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/93.d6bfc60d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/94.f5f030f3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/95.b17d2c48.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/96.fa0a349d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/97.bfa9967a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/98.e66016d8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/99.683783ef.js">
    <link rel="stylesheet" href="https://cdn.qiufeng.blue/assets/css/0.styles.29336953.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">秋风的笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/svelte/" class="nav-link">Svelte系列</a></div><div class="nav-item"><a href="/three/" class="nav-link">Three.js系列</a></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">Node系列</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/svelte/" class="nav-link">Svelte系列</a></div><div class="nav-item"><a href="/three/" class="nav-link">Three.js系列</a></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">Node系列</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div style="padding-left:1.5rem;"><div class="qr"><img src="https://s3.qiufeng.blue/blog/erweima.jpg" alt="秋风的比较" width="120" height="120" loading="lazy"> <p class="we-intro">
    如果你对前端，Node，开源项目感兴趣请关注我的公众号 <a target="_blank" href="https://mp.weixin.qq.com/s/pKoliWlgtV-qm6orbyTz0Q">秋风的笔记</a>。
  </p></div></div> <ul class="sidebar-links"><li><a href="/node/mutiple-download.html" aria-current="page" class="active sidebar-link">前端多线程大文件下载实践，提速10倍+</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#range-基本介绍" class="sidebar-link">Range 基本介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#range的起源" class="sidebar-link">Range的起源</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#浏览器支持情况" class="sidebar-link">浏览器支持情况</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#服务器支持" class="sidebar-link">服务器支持</a></li></ul></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#range实践" class="sidebar-link">Range实践</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#探索失败的原因" class="sidebar-link">探索失败的原因</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#服务器带宽大于用户带宽-不做任何限制" class="sidebar-link">服务器带宽大于用户带宽，不做任何限制</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#服务器带宽远大于用户带宽-限制单连接网速" class="sidebar-link">服务器带宽远大于用户带宽，限制单连接网速</a></li></ul></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#改进方案" class="sidebar-link">改进方案</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#实际应用探索" class="sidebar-link">实际应用探索</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#网易云课堂" class="sidebar-link">网易云课堂</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#百度云" class="sidebar-link">百度云</a></li></ul></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#方案缺陷" class="sidebar-link">方案缺陷</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#_1-对于大文件的上限有一定的限制" class="sidebar-link">1.对于大文件的上限有一定的限制</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#_2-服务器对单个tcp速度有所限制" class="sidebar-link">2. 服务器对单个TCP速度有所限制</a></li></ul></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#结尾" class="sidebar-link">结尾</a></li><li class="sidebar-sub-header"><a href="/node/mutiple-download.html#参考文献" class="sidebar-link">参考文献</a></li></ul></li><li><a href="/node/file-download.html" class="sidebar-link">一文带你层层解锁「文件下载」的奥秘</a></li><li><a href="/node/upload.html" class="sidebar-link"> 一文了解文件上传全过程（1.8w字深度解析，进阶必备）</a></li><li><a href="/node/color.html" class="sidebar-link"> 让浏览器添上终端的彩</a></li><li><a href="/node/crawler.html" class="sidebar-link"> 手把手教你多页面递归爬虫--基于Node.Js</a></li><li><a href="/node/node-addon.html" class="sidebar-link"> Node + NAPI 实现 C++ 扩展 - LRU 淘汰算法</a></li><li><a href="/node/node-cli-count.html" class="sidebar-link"> 开发一个Node小玩具全过程</a></li><li><a href="/node/node-git-down.html" class="sidebar-link"> 对症下药，快速下载github单个文件夹</a></li><li><a href="/node/pkg.html" class="sidebar-link"> pkg版本规范管理自动化最佳实践</a></li><li><a href="/node/shark-cleaner.html" class="sidebar-link"> shark-cleaner: 一个Node Cli 实现的垃圾清理工具(深层清理开发垃圾)</a></li><li><a href="/node/translate.html" class="sidebar-link"> 一个免费功能强大的谷歌翻译api</a></li></ul> </aside> <!----> <!----> <main class="page"><div class="theme-default-content" style="margin-top:3.6rem;padding-top:0;padding-bottom:0;"><div class="bar-container"><div class="bar-intro"><div class="text"><p>阿里云优惠活动，点击链接进行购买: <a href="https://www.aliyun.com/minisite/goods?userCode=qtt5ztpk">一年仅需96.9元即可以购买服务器~ </a></p> <p>腾讯云优惠活动, 点击链接进行购买<a href="https://curl.qcloud.com/mcBHz0hb">一年仅需99元</a></p> <p>腾讯云限时开团活动, 点击链接进行购买<a href="https://cloud.tencent.com/act/cvmgift?hash=K468jiO7GIO6QaYN">一年仅需95元</a></p> <p><a href="/op/service-choice.html">各大服务器厂商对比选购</a></p></div></div></div> <!----></div> <div class="theme-default-content"><div class="content__default"><h1 id="⚡️前端多线程大文件下载实践-提速10倍"><a href="#⚡️前端多线程大文件下载实践-提速10倍" class="header-anchor">#</a> ⚡️前端多线程大文件下载实践，提速10倍+</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>没错，你没有看错，是前端多线程，而不是<code>Node</code>。这一次的探索起源于最近开发中，有遇到视频流相关的开发需求发现了一个特殊的状态码，他的名字叫做 <code>206</code>~</p> <p><img src="https://s3.qiufeng.blue/blog/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202020-09-21%2023.21.05.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="屏幕快照 2020-09-21 23.21.05"></p> <p>为了防止本文的枯燥，先上效果图镇文。(以一张<code>3.7M</code> 大小的图片为例)。</p> <p><strong>动画效果对比（单线程-左 VS 10个线程-右）</strong></p> <p><img src="https://s3.qiufeng.blue/blog/single-vs-multiple-donwload.gif?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="single-vs-multiple-donwload"></p> <p><strong>时间对比（单线程 VS 10个线程）</strong></p> <p><img src="https://s3.qiufeng.blue/blog/image-20200915235421355.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200915235421355"></p> <p>看到这里是不是有点心动，那么请你继续听我道来，那我们先抓个包来看看整个过程是怎么发生的。</p> <div class="language- extra-class"><pre class="language-text"><code>GET /360_0388.jpg HTTP/1.1
Host: limit.qiufeng.com
Connection: keep-alive
...
Range: bytes=0-102399

HTTP/1.1 206 Partial Content
Server: openresty/1.13.6.2
Date: Sat, 19 Sep 2020 06:31:11 GMT
Content-Type: image/jpeg
Content-Length: 102400
....
Content-Range: bytes 0-102399/3670627

...（这里是文件流）
</code></pre></div><p>可以看到请求这里多出一个字段 <code>Range: bytes=0-102399</code> ，服务端也多出一个字段<code>Content-Range: bytes 0-102399/3670627</code>，以及返回的 状态码为 <code>206</code>.</p> <p>那么<code>Range</code>是什么呢？还记得前几天写过一篇文章，是关于文件下载的，其中有提到大文件的下载方式，有个叫 <code>Range</code>的东西，但是<a href="https://juejin.im/post/6867469476196155400" target="_blank" rel="noopener noreferrer">上一篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>作为系统性地介绍文件下载的概览，因此没有对<code>range</code> 进行详细介绍。</p> <blockquote><p>以下所有代码均在 https://github.com/hua1995116/node-demo/tree/master/file-download/example/download-multiple</p></blockquote> <h2 id="range-基本介绍"><a href="#range-基本介绍" class="header-anchor">#</a> Range 基本介绍</h2> <h3 id="range的起源"><a href="#range的起源" class="header-anchor">#</a> Range的起源</h3> <p><code>Range</code>是在 <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.17" target="_blank" rel="noopener noreferrer">HTTP/1.1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中新增的一个字段，这个特性也是我们使用的迅雷等支持多线程下载以及断点下载的核心机制。（介绍性的文案，摘录了一下）</p> <p>首先客户端会发起一个带有<code>Range: bytes=0-xxx</code>的请求，如果服务端支持 Range，则会在响应头中添加<code>Accept-Ranges: bytes</code>来表示支持 Range 的请求，之后客户端才可能发起带 Range 的请求。</p> <p>服务端通过请求头中的<code>Range: bytes=0-xxx</code>来判断是否是进行 Range 处理，如果这个值存在而且有效，则只发回请求的那部分文件内容，响应的状态码变成206，表示Partial Content，并设置Content-Range。如果无效，则返回416状态码，表明Request Range Not Satisfiable。如果请求头中不带 Range，那么服务端则正常响应，也不会设置 Content-Range 等。</p> <table><thead><tr><th style="text-align:left;">Value</th> <th style="text-align:center;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;">206</td> <td style="text-align:center;">Partial Content</td></tr> <tr><td style="text-align:left;">416</td> <td style="text-align:center;">Range Not Satisfiable</td></tr></tbody></table> <p>Range的格式为：</p> <p><code>Range:(unit=first byte pos)-[last byte pos]</code></p> <p>即<code>Range: 单位（如bytes）= 开始字节位置-结束字节位置</code>。</p> <p>我们来举个例子，假设我们开启了多线程下载，需要把一个5000byte的文件分为4个线程进行下载。</p> <ul><li>Range: bytes=0-1199 头1200个字节</li> <li>Range: bytes=1200-2399 第二个1200字节</li> <li>Range: bytes=2400-3599 第三个1200字节</li> <li>Range: bytes=3600-5000 最后的1400字节</li></ul> <p>服务器给出响应：</p> <p>第1个响应</p> <ul><li>Content-Length：1200</li> <li>Content-Range：bytes 0-1199/5000</li></ul> <p>第2个响应</p> <ul><li>Content-Length：1200</li> <li>Content-Range：bytes 1200-2399/5000</li></ul> <p>第3个响应</p> <ul><li>Content-Length：1200</li> <li>Content-Range：bytes 2400-3599/5000</li></ul> <p>第4个响应</p> <ul><li>Content-Length：1400</li> <li>Content-Range：bytes 3600-5000/5000</li></ul> <p>如果每个请求都成功了，服务端返回的response头中有一个 Content-Range 的字段域，Content-Range 用于响应头，告诉了客户端发送了多少数据，它描述了响应覆盖的范围和整个实体长度。一般格式：</p> <p><code>Content-Range: bytes (unit first byte pos) - [last byte pos]/[entity length]</code>即<code>Content-Range：字节 开始字节位置-结束字节位置／文件大小</code>。</p> <h3 id="浏览器支持情况"><a href="#浏览器支持情况" class="header-anchor">#</a> 浏览器支持情况</h3> <p>主流浏览器目前都支持这个特性。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200916002624861.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200916002624861"></p> <h3 id="服务器支持"><a href="#服务器支持" class="header-anchor">#</a> 服务器支持</h3> <h4 id="nginx"><a href="#nginx" class="header-anchor">#</a> Nginx</h4> <p>在版本nginx版本 1.9.8 后，（加上 ngx_http_slice_module）默认自动支持，可以将 <code>max_ranges</code> 设置为 <code>0</code>的来取消这个设置。</p> <h4 id="node"><a href="#node" class="header-anchor">#</a> Node</h4> <p>Node 默认不提供 对 <code>Range</code>方法的处理，需要自己写代码进行处理。</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/rangeFile'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> size <span class="token punctuation">}</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./static/'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> range <span class="token operator">=</span> ctx<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'range'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>range<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">,</span> <span class="token string">'bytes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./static/'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;=</span> size <span class="token operator">||</span> end <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">416</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">206</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">,</span> <span class="token string">'bytes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Range'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>end <span class="token operator">?</span> end <span class="token operator">:</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./static/'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>或者你可以使用 <code>koa-send</code> 这个库。</p> <p>https://github.com/pillarjs/send/blob/0.17.1/index.js#L680</p> <h2 id="range实践"><a href="#range实践" class="header-anchor">#</a> Range实践</h2> <p><strong>架构总览</strong></p> <p>我们先来看下流程架构图总览。单线程很简单，正常下载就可以了，不懂的可以参看我<a href="https://juejin.im/post/6867469476196155400" target="_blank" rel="noopener noreferrer">上一篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文章。多线程的话，会比较麻烦一些，需要按片去下载，下载好后，需要进行合并再进行下载。（关于blob等下载方式依旧可以参看<a href="https://juejin.im/post/6867469476196155400" target="_blank" rel="noopener noreferrer">上一篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <p><img src="https://s3.qiufeng.blue/blog/1600705973008.jpg?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="1600705973008"></p> <p><strong>服务端代码</strong></p> <p>很简单，就是对<code>Range</code>做了兼容。</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/rangeFile'</span><span class="token punctuation">,</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> size <span class="token punctuation">}</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./static/'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> range <span class="token operator">=</span> ctx<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'range'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>range<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">,</span> <span class="token string">'bytes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./static/'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;=</span> size <span class="token operator">||</span> end <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">416</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">206</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">,</span> <span class="token string">'bytes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Range'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>end <span class="token operator">?</span> end <span class="token operator">:</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./static/'</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>html</strong></p> <p>然后来编写 html ，这没有什么好说的，写两个按钮来展示。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>download1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>串行下载<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>download2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>多线程下载<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/axios/0.19.2/axios.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>js公共参数</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">520</span><span class="token punctuation">;</span>  <span class="token comment">// 分片的大小</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://localhost:8888/api/rangeFile?filename=360_0388.jpg'</span><span class="token punctuation">;</span> <span class="token comment">// 要下载的地址</span>
</code></pre></div><p><strong>单线程部分</strong></p> <p>单线程下载代码，直接去请求以<code>blob</code>方式获取，然后用<code>blobURL</code> 的方式下载。</p> <div class="language-js extra-class"><pre class="language-js"><code>download1<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;直接下载&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;blob&quot;</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">oEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> content <span class="token operator">=</span> req<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
            <span class="token keyword">const</span> aTag <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            aTag<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">'360_0388.jpg'</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> blobUrl <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            aTag<span class="token punctuation">.</span>href <span class="token operator">=</span> blobUrl<span class="token punctuation">;</span>
            aTag<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;直接下载&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">download</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>多线程部分</strong></p> <p>首先发送一个 head 请求，来获取文件的大小，然后根据 length 以及设置的分片大小，来计算每个分片是滑动距离。通过<code>Promise.all</code>的回调中，用<code>concatenate</code>函数对分片 buffer 进行一个合并成一个 blob，然后用<code>blobURL</code> 的方式下载。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// script</span>
<span class="token keyword">function</span> <span class="token function">downloadRange</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>end<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;blob&quot;</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">oEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            req<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    i<span class="token punctuation">,</span>
                    buffer<span class="token operator">:</span> res
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 合并buffer</span>
<span class="token keyword">function</span> <span class="token function">concatenate</span><span class="token punctuation">(</span><span class="token parameter">resultConstructor<span class="token punctuation">,</span> arrays</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> totalLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> arr <span class="token keyword">of</span> arrays<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        totalLength <span class="token operator">+=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">resultConstructor</span><span class="token punctuation">(</span>totalLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> arr <span class="token keyword">of</span> arrays<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        offset <span class="token operator">+=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
download2<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token punctuation">,</span>
        method<span class="token operator">:</span> <span class="token string">'head'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取长度来进行分割块</span>
        console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;并发下载&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>size <span class="token operator">/</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> start <span class="token operator">=</span> i <span class="token operator">*</span> m<span class="token punctuation">;</span>
            <span class="token keyword">let</span> end <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span>  size <span class="token operator">-</span> <span class="token number">1</span>  <span class="token operator">:</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">downloadRange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> arrBufferList <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>i <span class="token operator">-</span> item<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> allBuffer <span class="token operator">=</span> <span class="token function">concatenate</span><span class="token punctuation">(</span>Uint8Array<span class="token punctuation">,</span> arrBufferList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>allBuffer<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'image/jpeg'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> blobUrl <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> aTag <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            aTag<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">'360_0388.jpg'</span><span class="token punctuation">;</span>
            aTag<span class="token punctuation">.</span>href <span class="token operator">=</span> blobUrl<span class="token punctuation">;</span>
            aTag<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;并发下载&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>完整示例</p> <blockquote><p>https://github.com/hua1995116/node-demo</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>// 进入目录
cd file-download
// 启动
node server.js
// 打开 
http://localhost:8888/example/download-multiple/index.html
</code></pre></div><p>由于谷歌浏览器在 HTTP/1.1 对于单个域名有所限制，单个域名最大的并发量是 6.</p> <p>这一点可以在源码以及官方人员的讨论中体现。</p> <p>讨论地址</p> <p>https://bugs.chromium.org/p/chromium/issues/detail?id=12066</p> <p>Chromium 源码</p> <div class="language-c++ extra-class"><pre class="language-text"><code>// https://source.chromium.org/chromium/chromium/src/+/refs/tags/87.0.4268.1:net/socket/client_socket_pool_manager.cc;l=47
// Default to allow up to 6 connections per host. Experiment and tuning may
// try other values (greater than 0).  Too large may cause many problems, such
// as home routers blocking the connections!?!?  See http://crbug.com/12066.
//
// WebSocket connections are long-lived, and should be treated differently
// than normal other connections. Use a limit of 255, so the limit for wss will
// be the same as the limit for ws. Also note that Firefox uses a limit of 200.
// See http://crbug.com/486800
int g_max_sockets_per_group[] = {
    6,   // NORMAL_SOCKET_POOL
    255  // WEBSOCKET_SOCKET_POOL
};
</code></pre></div><p>因此为了配合这个特性我将文件分成6个片段，每个片段为<code>520kb</code> （没错，写个代码都要搞个爱你的数字），即开启6个线程进行下载。</p> <p>我用单个线程和多个线程进行分别下载了6次，看上去速度是差不多的。那么为什么和我们预期的不一样呢?</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919165242745.png" alt="image-20200919165242745"></p> <h2 id="探索失败的原因"><a href="#探索失败的原因" class="header-anchor">#</a> 探索失败的原因</h2> <p>我开始仔细对比两个请求，观察这两个请求的速度。</p> <p><strong>6个线程并发</strong></p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919170313455.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200919170313455"></p> <p><strong>单个线程</strong></p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919170512650.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200919170512650"></p> <p>我们按照3.7M 82ms 的速度来算的话，大约为 1ms 下载 46kb，而实际情况可以看到，533kb ，平均就要下载 20ms 左右（已经刨去了连接时间，纯 content 下载时间）。</p> <p>我就去查找了一些资料，明白了有个叫做下行速度和上行速度的东西。</p> <blockquote><p>网络的实际传输速度要分上行速度和下行速度，<a href="https://baike.baidu.com/item/%E4%B8%8A%E8%A1%8C%E9%80%9F%E7%8E%87" target="_blank" rel="noopener noreferrer">上行速率<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>就是发送出去数据的速度，下行就是收到数据的速度。ADSL是根据我们平时上网，发出数据的要求相对下载数据的较小这种习惯来实现的一种传输方式。我们说对于4M的<a href="https://baike.baidu.com/item/%E5%AE%BD%E5%B8%A6" target="_blank" rel="noopener noreferrer">宽带<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，那么我们的l理论最高下载速度就是512K/S，这就是所说的下行速度。  --百度百科</p></blockquote> <p>那我们现在的情况是怎么样的呢？</p> <p>把服务器比作一根大水管，我来用图模拟一下我们单个线程和多个线程下载的情况。左侧为服务器端，右侧为客户端。（以下所有情况都是考虑理想情况下，只是为了模拟过程，不考虑其他一些程序的竞态影响。）</p> <p><strong>单线程</strong></p> <p><img src="https://s3.qiufeng.blue/blog/IMG_01.jpg?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="IMG_01"></p> <p><strong>多线程</strong></p> <p><img src="https://s3.qiufeng.blue/blog/IMG_02.jpg?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="IMG_02"></p> <p>没错，由于我们的服务器是一根大水管，流速是一定的，并且我们客户端没有限制。如果是单线程跑的话，那么会跑满用户的最大的速度。如果是多线程呢，以3个线程为例子的话，相当于每个线程都跑了原先线程三分之一的速度。合起来的速度和单个线程是没有差别的。</p> <p>下面我就分几种情况来讲解一下，什么样的情况才我们的多线程才会生效呢？</p> <h3 id="服务器带宽大于用户带宽-不做任何限制"><a href="#服务器带宽大于用户带宽-不做任何限制" class="header-anchor">#</a> 服务器带宽大于用户带宽，不做任何限制</h3> <p>这种情况其实我们遇到的情况差不多的。</p> <h3 id="服务器带宽远大于用户带宽-限制单连接网速"><a href="#服务器带宽远大于用户带宽-限制单连接网速" class="header-anchor">#</a> 服务器带宽远大于用户带宽，限制单连接网速</h3> <p><img src="https://s3.qiufeng.blue/blog/IMG_03.jpg?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="IMG_03"></p> <p>如果服务器限制了单个宽带的下载速度，大部分也是这种情况，例如百度云就是这样，例如明明你是 10M 的宽带，但是实际下载速度只有 100kb/s ，这种情况下，我们就可以开启多线程去下载，因为它往往限制的是单个TCP的下载，当然在线上环境不是说可以让用户开启无限多个线程，还是会有限制的，会限制你当前IP的最大TCP。这种情况下下载的上限往往是你的用户最大速度。按照上面的例子，如果你开10个线程已经达到了最大速度，因为再大，你的入口已经被限制死了，那么各个线程之间就会抢占速度，再多开线程也没有用了。</p> <h2 id="改进方案"><a href="#改进方案" class="header-anchor">#</a> 改进方案</h2> <p>由于 Node 我暂时没有找到比较简单地控制下载速度的方法，因此我就引入了 Nginx。</p> <p>我们将每个TCP连接的速度控制在 1M/s。</p> <p>加入配置 <code>limit_rate 1M;</code></p> <p><strong>准备工作</strong></p> <p>1.nginx_conf</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span> limit<span class="token punctuation">.</span>qiufeng<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">access_log</span>  <span class="token operator">/</span>opt<span class="token operator">/</span>logs<span class="token operator">/</span>wwwlogs<span class="token operator">/</span>limitqiufeng<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
    <span class="token keyword">error_log</span>  <span class="token operator">/</span>opt<span class="token operator">/</span>logs<span class="token operator">/</span>wwwlogs<span class="token operator">/</span>limitqiufeng<span class="token punctuation">.</span>error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

    <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Methods <span class="token string">'GET, OPTIONS'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Headers <span class="token string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,range,If-Range'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">204</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">limit_rate</span> <span class="token number">1</span>M<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">root</span> 你的静态目录<span class="token punctuation">;</span>
        <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2.配置本地 host</p> <div class="language- extra-class"><pre class="language-text"><code>127.0.0.1 limit.qiufeng.com
</code></pre></div><p>查看效果，这下基本上速度已经是正常了，多线程下载比单线程快了速度。基本是 5-6 : 1 的速度，但是发现如果下载过程中快速点击数次后，使用<code>Range</code>下载会越来越快（此处怀疑是 Nginx 做了什么缓存，暂时没有深入研究）。</p> <div class="language-js extra-class"><pre class="language-js"><code>修改代码中的下载地址
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://localhost:8888/api/rangeFile?filename=360_0388.jpg'</span><span class="token punctuation">;</span>
变成
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'http://limit.qiufeng.com/360_0388.jpg'</span><span class="token punctuation">;</span>
</code></pre></div><p>测试下载速度</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919201613507.png" alt="image-20200919201613507"></p> <p>还记得上面说的吗，关于 <code>HTTP/1.1</code> 同一站点只能并发 6 个请求，多余的请求会放到下一个批次。但是 <code>HTTP/2.0</code> 不受这个限制，多路复用代替了 <code>HTTP/1.x</code> 的<strong>序列和阻塞机制</strong>。让我们来升级 <code>HTTP/2.0</code> 来测试一下。</p> <p>需要本地生成一个证书。（生成证书方法: https://juejin.im/post/6844903556722475021）</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>
    <span class="token keyword">ssl</span> on<span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>openresty<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span><span class="token keyword">server</span><span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
    <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>openresty<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span><span class="token keyword">server</span><span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    <span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span>le_nginx_SSL<span class="token punctuation">:</span><span class="token number">1</span>m<span class="token punctuation">;</span>
    <span class="token keyword">ssl_session_timeout</span> <span class="token number">1440</span>m<span class="token punctuation">;</span>

    <span class="token keyword">ssl_protocols</span> SSLv3 TLSv1 TLSv1<span class="token punctuation">.</span><span class="token number">1</span> TLSv1<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">ssl_ciphers</span> RC4<span class="token punctuation">:</span>HIGH<span class="token punctuation">:</span><span class="token operator">!</span>aNULL<span class="token punctuation">:</span><span class="token operator">!</span>MD5<span class="token punctuation">;</span>
    <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>
    <span class="token keyword">server_name</span> limit<span class="token punctuation">.</span>qiufeng<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
 
    <span class="token keyword">access_log</span>  <span class="token operator">/</span>opt<span class="token operator">/</span>logs<span class="token operator">/</span>wwwlogs<span class="token operator">/</span>limitqiufeng2<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
    <span class="token keyword">error_log</span>  <span class="token operator">/</span>opt<span class="token operator">/</span>logs<span class="token operator">/</span>wwwlogs<span class="token operator">/</span>limitqiufeng2<span class="token punctuation">.</span>error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

    <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Methods <span class="token string">'GET, OPTIONS'</span><span class="token punctuation">;</span>
    <span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Headers <span class="token string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,range,If-Range'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">204</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">limit_rate</span> <span class="token number">1</span>M<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
        <span class="token keyword">root</span> 你存放项目的前缀路径<span class="token operator">/</span>node<span class="token operator">-</span>demo<span class="token operator">/</span>file<span class="token operator">-</span>download<span class="token operator">/</span><span class="token punctuation">;</span>
        <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>10个线程</p> <div class="language- extra-class"><pre class="language-text"><code>将单个下载大小进行修改
const m = 1024 * 400;
</code></pre></div><p><img src="https://s3.qiufeng.blue/blog/image-20200919200203877.png" alt="image-20200919200203877"></p> <p>12个线程</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919202302096.png" alt="image-20200919202302096"></p> <p>24个线程</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919202138838.png" alt="image-20200919202138838"></p> <p>当然线程不是越多越好，经过测试，发现线程达到一定数量的时候，反而速度会更加缓慢。以下是 36个并发请求的效果图。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919202427985.png" alt="image-20200919202427985"></p> <h2 id="实际应用探索"><a href="#实际应用探索" class="header-anchor">#</a> 实际应用探索</h2> <p>那么多进程下载到底有啥用呢？没错，开头也说了，这个分片机制是迅雷等下载软件的核心机制。</p> <h3 id="网易云课堂"><a href="#网易云课堂" class="header-anchor">#</a> 网易云课堂</h3> <p>https://study.163.com/course/courseLearn.htm?courseId=1004500008#/learn/video?lessonId=1048954063&amp;courseId=1004500008</p> <p>我们打开控制台，很容易地发现这个下载 url，直接一个裸奔的 mp4 下载地址。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200920222053726.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200920222053726"></p> <p>把我们的测试脚本从控制台输入进行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 测试脚本，由于太长了，而且如果仔细看了上面的文章也应该能写出代码。实在写不出可以看以下代码。</span>
https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>hua1995116<span class="token operator">/</span>node<span class="token operator">-</span>demo<span class="token operator">/</span>blob<span class="token operator">/</span>master<span class="token operator">/</span>file<span class="token operator">-</span>download<span class="token operator">/</span>example<span class="token operator">/</span>download<span class="token operator">-</span>multiple<span class="token operator">/</span>script<span class="token punctuation">.</span>js
</code></pre></div><p><strong>直接下载</strong></p> <p><img src="https://s3.qiufeng.blue/blog/image-20200920221657541.png" alt="image-20200920221657541"></p> <p><strong>多线程下载</strong></p> <p><img src="https://s3.qiufeng.blue/blog/image-20200920221853959.png" alt="image-20200920221853959"></p> <p>可以看到由于网易云课堂对单个TCP的下载速度并没有什么限制没有那么严格，提升的速度不是那么明显。</p> <h3 id="百度云"><a href="#百度云" class="header-anchor">#</a> 百度云</h3> <p>我们就来测试一下网页版的百度云。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919210106839.png" alt="image-20200919210106839"></p> <p>以一个 16.6M的文件为例。</p> <p>打开网页版百度云盘的界面，点击下载</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200920222309345.png" alt="image-20200920222309345"></p> <p>这个时候点击暂停, 打开 <code>chrome -&gt; 更多 -&gt; 下载内容 -&gt; 右键复制下载链接</code></p> <p><img src="https://s3.qiufeng.blue/blog/image-20200922004619680.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200922004619680"></p> <p>依旧用上述的网易云课程下载课程的脚本。只不过你需要改一下参数。</p> <div class="language- extra-class"><pre class="language-text"><code>url 改成对应百度云下载链接
m 改成 1024 * 1024 * 2 合适的分片大小~
</code></pre></div><p><strong>直接下载</strong></p> <p>百度云多单个TCP连接的限速，真的是惨无人道，足足花了217秒！！！就一个17M的文件，平时我们饱受了它多少的折磨。（除了VIP玩家）</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919211105023.png" alt="image-20200919211105023"></p> <p><strong>多线程下载</strong></p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919210516632.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200919210516632"></p> <p>由于是HTTP/1.1 因此我们只要开启6个以及以上的线程下载就好了。以下是多线程下载的速度，约用时 46 秒。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200919210550840.png" alt="image-20200919210550840"></p> <p>我们通过这个图再来切身感受一下速度差异。</p> <p><img src="https://s3.qiufeng.blue/blog/image-20200922010911389.png?imageView2/0/q/75%7Cwatermark/1/image/aHR0cHM6Ly9zMy5xaXVmZW5naC5jb20vd2F0ZXJtYXJrL3dhdGVybWFyay5wbmc=/dissolve/50/gravity/SouthEast/dx/0/dy/0" alt="image-20200922010911389"></p> <p>真香，免费且只靠我们前端自己实现了这个功能，太tm香了，你还不赶紧来试试？？</p> <h2 id="方案缺陷"><a href="#方案缺陷" class="header-anchor">#</a> 方案缺陷</h2> <h3 id="_1-对于大文件的上限有一定的限制"><a href="#_1-对于大文件的上限有一定的限制" class="header-anchor">#</a> 1.对于大文件的上限有一定的限制</h3> <p>由于 <code>blob</code> 在 各大浏览器有上限大小的限制，因此该方法还是存在一定的缺陷。</p> <table><thead><tr><th>Browser</th> <th>Constructs as</th> <th>Filenames</th> <th>Max Blob Size</th> <th>Dependencies</th></tr></thead> <tbody><tr><td>Firefox 20+</td> <td>Blob</td> <td>Yes</td> <td>800 MiB</td> <td>None</td></tr> <tr><td>Firefox &lt; 20</td> <td>data: URI</td> <td>No</td> <td>n/a</td> <td><a href="https://github.com/eligrey/Blob.js" target="_blank" rel="noopener noreferrer">Blob.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>Chrome</td> <td>Blob</td> <td>Yes</td> <td><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=375297#c107" target="_blank" rel="noopener noreferrer">2GB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>None</td></tr> <tr><td>Chrome for Android</td> <td>Blob</td> <td>Yes</td> <td><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=375297#c107" target="_blank" rel="noopener noreferrer">RAM/5<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>None</td></tr> <tr><td>Edge</td> <td>Blob</td> <td>Yes</td> <td>?</td> <td>None</td></tr> <tr><td>IE 10+</td> <td>Blob</td> <td>Yes</td> <td>600 MiB</td> <td>None</td></tr> <tr><td>Opera 15+</td> <td>Blob</td> <td>Yes</td> <td>500 MiB</td> <td>None</td></tr> <tr><td>Opera &lt; 15</td> <td>data: URI</td> <td>No</td> <td>n/a</td> <td><a href="https://github.com/eligrey/Blob.js" target="_blank" rel="noopener noreferrer">Blob.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>Safari 6.1+*</td> <td>Blob</td> <td>No</td> <td>?</td> <td>None</td></tr> <tr><td>Safari &lt; 6</td> <td>data: URI</td> <td>No</td> <td>n/a</td> <td><a href="https://github.com/eligrey/Blob.js" target="_blank" rel="noopener noreferrer">Blob.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>Safari 10.1+</td> <td>Blob</td> <td>Yes</td> <td>n/a</td> <td>None</td></tr></tbody></table> <h3 id="_2-服务器对单个tcp速度有所限制"><a href="#_2-服务器对单个tcp速度有所限制" class="header-anchor">#</a> 2. 服务器对单个TCP速度有所限制</h3> <p>一般情况下都会有限制，那么这个时候就看用户的宽度速度了。</p> <h2 id="结尾"><a href="#结尾" class="header-anchor">#</a> 结尾</h2> <p>文章写的比较仓促，表达可能不是特别精准，如有错误之处，欢迎各位大佬指出。</p> <p>回头调研下，有没有网页版百度云加速的插件，如果没有就造一个网页版百度云下载的插件~。</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <p>Nginx带宽控制 : https://blog.huoding.com/2015/03/20/423</p> <p>openresty 部署 https 并开启 http2 支持  : https://www.gryen.com/articles/show/5.html</p> <p>聊一聊HTTP的Range : https://dabing1022.github.io/2016/12/24/%E8%81%8A%E4%B8%80%E8%81%8AHTTP%E7%9A%84Range,%20Content-Range/</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/8/2021, 1:38:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/node/file-download.html">一文带你层层解锁「文件下载」的奥秘</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="https://cdn.qiufeng.blue/assets/js/app.1a0fcd74.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/3.8063c28d.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/2.bf4393a2.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/87.1e21499f.js" defer></script>
  </body>
</html>
