(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{501:function(t,e,o){"use strict";o.r(e);var v=o(44),r=Object(v.a)({},(function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[o("h1",{attrs:{id:"react-hooks中这样写http请求可以避免内存泄漏"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#react-hooks中这样写http请求可以避免内存泄漏"}},[t._v("#")]),t._v(" React Hooks中这样写HTTP请求可以避免内存泄漏")]),t._v(" "),o("blockquote",[o("p",[t._v("译文来自 https://dev.to/somedood/best-practices-for-es2017-asynchronous-functions-async-await-39ji")]),t._v(" "),o("p",[t._v("原作者 Victor de la Fouchardière")]),t._v(" "),o("p",[t._v("译者: 蓝色的秋风(github/hua1995116)")])]),t._v(" "),o("p",[t._v("大家好 ！ 👋")]),t._v(" "),o("p",[t._v("今天，让我们看一下在 React Hooks 中使用 "),o("code",[t._v("fetch")]),t._v(" 和"),o("code",[t._v("Abort Controller")]),t._v("取消Web请求从而来避免内存泄露！ 🤗")]),t._v(" "),o("p",[t._v("当我们用 Fetch 来管理数据时，有时我们想取消请求（例如，当我们离开当前页面时，当我们关闭模态框，...）。")]),t._v(" "),o("p",[t._v("在👇下面的示例中，我们要在切换路由的时候获取并展示数据。 但是，我们在获取数据完毕之前就离开了路由/页面。")]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/7p2coedr8hhtdltuzxu1.gif",alt:"7p2coedr8hhtdltuzxu1"}})]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/4uoij0o2qmdlppeykeln.png",alt:"4uoij0o2qmdlppeykeln"}})]),t._v(" "),o("p",[t._v("我们刚刚看到了一个"),o("strong",[t._v("内存泄漏")]),t._v("!让我们看看为什么会出现这个错误，以及它的具体含义。")]),t._v(" "),o("p",[o("strong",[t._v("❓为什么有内存泄漏？")]),t._v("：我们有一个执行异步"),o("code",[t._v("fetch(url)")]),t._v("任务的组件，然后更新该组件的状态来显示元素，"),o("strong",[t._v("但是")]),t._v("我们在请求完成之前就卸载(unmounted)了该组件。 由于已卸载组件的状态（例如 "),o("code",[t._v("setUsers")]),t._v("，"),o("code",[t._v("setState")]),t._v("）被更新, 所以造成了此次"),o("strong",[t._v("内存泄露")]),t._v("。")]),t._v(" "),o("h2",{attrs:{id:"🚀让我们使用新的-abortcontroller-api"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#🚀让我们使用新的-abortcontroller-api"}},[t._v("#")]),t._v(" 🚀让我们使用新的 AbortController API！")]),t._v(" "),o("p",[o("strong",[t._v("Abort Controller")]),t._v(" 允许您订阅一个或多个Web请求，并具有取消请求的能力。 🔥")]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/fvipu2xkelip28hcfoqp.png",alt:"fvipu2xkelip28hcfoqp"}})]),t._v(" "),o("p",[t._v("现在，我们可以访问"),o("code",[t._v("controller.signal")]),t._v("。")]),t._v(" "),o("blockquote",[o("p",[t._v("“ 具有 "),o("code",[t._v("read-only")]),t._v("属性的 "),o("code",[t._v("AbortController")]),t._v("接口返回一个"),o("code",[t._v("AbortSignal")]),t._v(" (https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal) 对象实例，该实例可用于根据需要与DOM请求通信/中止它。”   来自MDN（https://developer.mozilla.org/en-US/docs/Web/API/AbortController）")])]),t._v(" "),o("p",[t._v("让我们看看如何使用它💪")]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/vlvi82bo5lk2nopqzn8z.png",alt:"vlvi82bo5lk2nopqzn8z"}})]),t._v(" "),o("p",[t._v("最后，如果我们想取消当前请求，只需调用"),o("code",[t._v("abort()")]),t._v("。 另外，你可以获取"),o("code",[t._v("controller.signal.aborted")]),t._v("，它是一个只读属性，它返回一个"),o("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Boolean",target:"_blank",rel:"noopener noreferrer"}},[o("code",[t._v("Boolean")]),o("OutboundLink")],1),t._v("表示与DOM通讯的信号是("),o("code",[t._v("true")]),t._v(")否("),o("code",[t._v("false")]),t._v(")已被放弃。")]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/yswm5mktqv16v0tiio9e.png",alt:"yswm5mktqv16v0tiio9e"}})]),t._v(" "),o("blockquote",[o("p",[t._v("❗️注意：调用"),o("code",[t._v("abort()")]),t._v("时，"),o("code",[t._v("fetch()")]),t._v(" promise 会以名为AbortError 的 DOMException reject。")])]),t._v(" "),o("p",[t._v("是的，你刚刚学习了如何取消Web请求！ 👏")]),t._v(" "),o("h2",{attrs:{id:"🤩让我们用react-hooks做到这一点"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#🤩让我们用react-hooks做到这一点"}},[t._v("#")]),t._v(" 🤩让我们用React Hooks做到这一点！")]),t._v(" "),o("p",[t._v("❌"),o("strong",[t._v("改造之前")])]),t._v(" "),o("p",[t._v("下面是一个组件示例，它请求数据并展示它们。")]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/466wuql2ru1fgkrc2snx.jpeg",alt:"466wuql2ru1fgkrc2snx"}})]),t._v(" "),o("p",[t._v("如果我们离开页面的速度太快而导致请求未完成："),o("strong",[t._v("MEMORY LEAK")])]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/daavdtgn3tvfeybcf3rq.png",alt:"daavdtgn3tvfeybcf3rq"}})]),t._v(" "),o("p",[t._v("✅ "),o("strong",[t._v("改造之后")])]),t._v(" "),o("p",[t._v("我们使用 "),o("code",[t._v("useEffect")]),t._v(" 来订阅我们的 "),o("code",[t._v("fetch")]),t._v(" 请求来避免内存泄漏。 当组件卸载(unmounted)时，我们使用"),o("code",[t._v("useEffect")]),t._v("的清理方法来调用"),o("code",[t._v("abort()")]),t._v("。")]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/zsr8g1ecnburui4rkje9.png",alt:"zsr8g1ecnburui4rkje9"}})]),t._v(" "),o("p",[t._v("现在，不再有内存泄漏！ 😍")]),t._v(" "),o("p",[o("img",{attrs:{src:"https://s3.qiufeng.blue/blog/wqa6uud2tnz90okxiy1e.gif",alt:"wqa6uud2tnz90okxiy1e"}})]),t._v(" "),o("p",[t._v("你可以在 https://abort-with-react-hooks.vercel.app/ 上查看此演示。")]),t._v(" "),o("p",[t._v("可以在 https://github.com/hua1995116/node-demo/react-abort 查看源码")]),t._v(" "),o("p",[t._v("干杯 🍻 🍻 🍻")])])}),[],!1,null,null,null);e.default=r.exports}}]);