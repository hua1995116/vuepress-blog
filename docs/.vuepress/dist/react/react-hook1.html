<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title> 函数式编程看React Hooks(一)简单React Hooks实现 | 秋风的笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fd8e413c5ce47d78c95f742fc41a7118";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <meta name="description" content="useEffect、useState、useMemo、useCallback源码实现">
    <meta name="keywords" content="React Hooks useEffect useState useMemo useCallback">
    
    <link rel="preload" href="https://cdn.qiufeng.blue/assets/css/0.styles.29336953.css" as="style"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/app.b83cabbc.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/3.8063c28d.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/2.bf4393a2.js" as="script"><link rel="preload" href="https://cdn.qiufeng.blue/assets/js/117.e1036e3e.js" as="script"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/10.bf58e465.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/100.5b053bd8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/101.39899c8d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/102.a23fbef8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/103.492a3553.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/104.a69ab504.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/105.a2b24389.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/106.f4d4cacc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/107.340d6ebe.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/108.b5554206.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/109.e17a4df3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/11.5003516c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/110.d3d1aeac.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/111.75b70359.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/112.9eddd03a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/113.a87330b6.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/114.5906ff5a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/115.04d5fad9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/116.6548dea3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/118.880cdcc2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/119.44ff47c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/12.bbe2f042.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/120.0ad1908a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/121.2053628b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/122.f94d67c2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/123.68c1118e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/124.775f2803.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/125.e2a44ee3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/126.e34736f4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/127.e4502464.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/128.2b32e0b0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/129.b519134c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/13.8f5fee3e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/130.c5c23fb1.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/131.2131b1ed.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/132.cc955e8a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/133.36781ad5.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/134.8eae5caf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/135.ae0a6a52.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/136.167be017.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/137.86ba4063.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/138.b70d6a55.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/139.bc1ecb45.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/14.31eeb321.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/140.d764335c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/141.ff5c010e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/142.160d4b80.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/143.316fd73e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/144.498a95e8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/145.7340204a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/146.73e58745.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/147.ba4c94bc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/148.2f001ec5.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/149.a3acb0d8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/15.6e23119d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/150.bb72c31e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/151.4cd99247.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/152.6b3388b2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/153.48daa859.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/154.33d50b3d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/16.f0cb3ea8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/17.86ad7537.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/18.6fc4c758.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/19.2b26db57.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/20.bfdee106.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/21.9d3794cf.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/22.d7da03ef.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/23.9d5de06f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/24.4a43f6ed.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/25.e993958e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/26.8dbf7c47.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/27.632a937b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/28.93e3e9dd.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/29.8092a94f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/30.26c79f1e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/31.59741ba9.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/32.85f21ead.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/33.3965fe8c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/34.2c3185d8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/35.aa5264c8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/36.f6963172.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/37.949d7cb5.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/38.d506651f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/39.205f646b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/4.51060f90.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/40.f775c381.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/41.8dafa68f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/42.8960edd3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/43.838bb5b0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/44.61eac578.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/45.d26568f5.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/46.99e4e93b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/47.67ded210.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/48.2ad5499e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/49.c734904a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/5.dc096b09.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/50.12def055.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/51.dcd80e19.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/52.f7b480f0.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/53.d67e6d8b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/54.c20e45cc.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/55.a5464295.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/56.96a32c1f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/57.19407be7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/58.c58c2d26.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/59.6dd1ccde.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/6.672abf41.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/60.fbe83a41.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/61.4eb8f9a4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/62.672bce04.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/63.737af55f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/64.cfa3c9ce.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/65.4860422b.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/66.52bfe3a7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/67.a776db77.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/68.7d0dafeb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/69.1f336f9a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/7.959da92e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/70.3d76a686.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/71.b5ecc2a7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/72.a204fb19.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/73.2e835294.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/74.0b7a8158.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/75.03b9b151.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/76.a21f020a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/77.26ddf3a4.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/78.72c61bd8.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/79.3826733e.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/8.f6bbf435.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/80.65de739c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/81.560b1637.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/82.6f8bd0c3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/83.7013cadb.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/84.a67136dd.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/85.0f24347d.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/86.64360ead.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/87.f6c58fc3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/88.fb741b57.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/89.a03ee6f2.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/9.4b6ccd84.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/90.43f7b0b7.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/91.1c94697f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/92.f3b6e6fa.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/93.d0b4671f.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/94.f5f030f3.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/95.379fd753.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/96.20a235fd.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/97.bfa9967a.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/98.d029420c.js"><link rel="prefetch" href="https://cdn.qiufeng.blue/assets/js/99.4a896bfb.js">
    <link rel="stylesheet" href="https://cdn.qiufeng.blue/assets/css/0.styles.29336953.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">秋风的笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link router-link-active">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/svelte/" class="nav-link">Svelte系列</a></div><div class="nav-item"><a href="/three/" class="nav-link">Three.js系列</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node系列</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端系列" class="dropdown-title"><span class="title">前端系列</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">js文章</a></li><li class="dropdown-item"><!----> <a href="/react/" class="nav-link router-link-active">react实践</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">vue实践</a></li><li class="dropdown-item"><!----> <a href="/debug/" class="nav-link">debug系列</a></li><li class="dropdown-item"><!----> <a href="/webpack/" class="nav-link">webpack系列</a></li><li class="dropdown-item"><!----> <a href="/canvas/" class="nav-link">canvas系列</a></li></ul></div></div><div class="nav-item"><a href="/svelte/" class="nav-link">Svelte系列</a></div><div class="nav-item"><a href="/three/" class="nav-link">Three.js系列</a></div><div class="nav-item"><a href="/node/" class="nav-link">Node系列</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/op/" class="nav-link">前端运维</a></div><div class="nav-item"><a href="/open/" class="nav-link">开源项目</a></div> <a href="https://github.com/hua1995116/vuepress-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div style="padding-left:1.5rem;"><div class="qr"><img src="https://s3.qiufeng.blue/blog/erweima.jpg" alt="秋风的比较" width="120" height="120" loading="lazy"> <p class="we-intro">
    如果你对前端，Node，开源项目感兴趣请关注我的公众号 <a target="_blank" href="https://mp.weixin.qq.com/s/pKoliWlgtV-qm6orbyTz0Q">秋风的笔记</a>。
  </p></div></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>实践篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/react-state-5-way.html" class="sidebar-link">谈谈React 5种最流行的状态管理库</a></li><li><a href="/react/cancel-react-hooks-request.html" class="sidebar-link">React Hooks中这样写HTTP请求可以避免内存泄漏</a></li><li><a href="/react/7-react-Conditional.html" class="sidebar-link">React 条件渲染最佳实践(7 种方法)</a></li><li><a href="/react/react-hook1.html" aria-current="page" class="active sidebar-link"> 函数式编程看React Hooks(一)简单React Hooks实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react-hook1.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#开始" class="sidebar-link">开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react-hook1.html#usestate" class="sidebar-link">useState</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#useeffect" class="sidebar-link">useEffect</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#usememo" class="sidebar-link">useMemo</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#usecallback" class="sidebar-link">useCallback</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#完整版" class="sidebar-link">完整版</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#完整渲染过程" class="sidebar-link">完整渲染过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/react-hook1.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#第一次渲染" class="sidebar-link">第一次渲染</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#事件触发" class="sidebar-link">事件触发</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#第二次渲染" class="sidebar-link">第二次渲染</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#后记" class="sidebar-link">后记</a></li><li class="sidebar-sub-header"><a href="/react/react-hook1.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/react/react-hook2.html" class="sidebar-link"> 函数式编程看React Hooks(二)事件绑定副作用深度剖析</a></li><li><a href="/react/shopping-cart.html" class="sidebar-link"> react+react-router 4.0+redux+antd购物车实战项目</a></li></ul></section></li></ul> </aside> <!----> <!----> <main class="page"><div class="theme-default-content" style="margin-top:3.6rem;padding-top:0;padding-bottom:0;"><div class="bar-container"><div class="bar-intro"><div class="text"><p>阿里云优惠活动，点击链接进行购买: <a href="https://www.aliyun.com/minisite/goods?userCode=qtt5ztpk">一年仅需96.9元即可以购买服务器~ </a></p> <p>腾讯云优惠活动, 点击链接进行购买<a href="https://curl.qcloud.com/mcBHz0hb">一年仅需99元</a></p> <p>腾讯云限时开团活动, 点击链接进行购买<a href="https://cloud.tencent.com/act/cvmgift?hash=K468jiO7GIO6QaYN">一年仅需95元</a></p> <p><a href="/op/service-choice.html">各大服务器厂商对比选购</a></p></div></div></div> <!----></div> <div class="theme-default-content"><div class="content__default"><h1 id="函数式编程看react-hooks-一-简单react-hooks实现"><a href="#函数式编程看react-hooks-一-简单react-hooks实现" class="header-anchor">#</a> 函数式编程看React Hooks(一)简单React Hooks实现</h1> <p><a href="/react/" class="router-link-active">函数式编程看React Hooks(一)简单React Hooks实现</a></p> <p><a href="/blog/article/han-shu-shi-bian-cheng-kan-ReactHooks(-er-)-shi-jian-bang-ding-fu-zuo-yong-shen-du-pou-xi-/">函数式编程看React Hooks(二)事件绑定副作用深度剖析</a></p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>函数式编程介绍（摘自基维百科）</p> <blockquote><p>函数式编程（英语：functional programming）或称函数程序设计、泛函编程，是一种编程范式，它将计算机运算视为函数运算，并且避免使用程序状态以及易变对象。其中，λ演算（lambda calculus）为该语言最重要的基础。而且，λ演算的函数可以接受函数当作输入（引数）和输出（传出值）。</p></blockquote> <p>面向对象编程介绍（摘自基维百科）</p> <blockquote><p>面向对象程序设计（英语：Object-oriented programming，缩写：OOP）是种具有对象概念的程序编程典范，同时也是一种程序开发的抽象方针。它可能包含数据、属性、代码与方法。对象则指的是类的实例。它将对象作为程序的基本单元，将程序和数据封装其中，以提高软件的重用性、灵活性和扩展性，对象里的程序可以访问及经常修改对象相关连的数据。在面向对象程序编程里，计算机程序会被设计成彼此相关的对象</p></blockquote> <p>函数式强调在逻辑处理中不变性。面向对象通过消息传递改变每个Object的内部状态。两者是截然不同的编程思想，都具有自己的优势，也因为如此，才使得我们从 <code>class 组件</code> 转化到 <code>函数组件式</code>，有一些费解。</p> <p>从 react 的变化可以看出，react 走的道路越来越接近于函数式编程，输入输出一致性。当然也不是凭空地去往这个方面，而是为了能够解决更多的问题。以下 三点是 react 官网所提到的 hooks 的动机 https://zh-hans.reactjs.org/docs/hooks-intro.html#motivation</p> <ul><li>代码重用：在hooks出来之前，常见的代码重用方式是 HOC 和render props，这两种方式带来的问题是：你需要解构自己的组件，同时会带来很深的组件嵌套</li> <li>复杂的组件逻辑：在class组件中，有许多的lifecycle 函数，你需要在各个函数的里面去做对应的事情。这种方式带来的痛点是：逻辑分散在各处，开发者去维护这些代码会分散自己的精力，理解代码逻辑也很吃力</li> <li>class组件的困惑：对于初学者来说，需要理解class组件里面的this是比较吃力的，同时，基于class的组件难以优化。</li></ul> <p>本文是为了给后面一篇文章作为铺垫，因为在之后文章的讲解过程中，你如果了理解了 React Hooks 的原理，再加上一步一步地讲解，你可能会对 React Hooks 中各种情况会恍然大悟。</p> <p>一开始的时候觉得 hooks 非常地神秘，写惯了 class 式的组件后，我们的思维就会定格在那里，生命周期，state，this等的使用。 因此会以 class 编写的模式去写函数式组件，导致我们一次又一次地爬坑，接下来我们就开始我们的实现方式讲解。（提示：以下是都只是一种简单的模拟方法，与实际有一些差别，但是核心思想是一致的）</p> <h2 id="开始"><a href="#开始" class="header-anchor">#</a> 开始</h2> <p>我们先写一个简单的 react 函数式组件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button<span class="token operator">&gt;</span>
        点击
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 React Hooks 还未出现的时候，我们的组件大多用来直接渲染，不含有状态存储，Function组件没有state，所以也叫SFC（stateless functional component），现在更新叫做FC（functional component）。</p> <p>为了使得一个函数内有状态，react 使用了一个特别的方法就是 hooks， 其实这是利用闭包实现的一个类似作用域的东西去存储状态，我第一想到的就是利用对象引用存储数据，就像是面向对象一样的方式，存在一个对象中中，通过引用的方式来进行获取。但是 react 为了能够尽可能地分离状态，精妙地采用了闭包。</p> <p>让我们看看他是如何实现的。(为了尽可能简化，我进行了改编)</p> <h3 id="usestate"><a href="#usestate" class="header-anchor">#</a> useState</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> _state<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_state <span class="token operator">=</span> _state <span class="token operator">||</span> initialState<span class="token punctuation">;</span> <span class="token comment">// 如果存在旧值则返回， 使得多次渲染后的依然能保持状态。</span>
  <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 重新渲染，将会重新执行 Counter</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>_state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        点击
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>演示地址： https://codesandbox.io/s/dawn-bash-rqqoh</p> <p>以上，不管 Counter 重新渲染多少次，通过闭包，依然能够访问到最新的 state，从而达到了存储状态的效果。</p> <h3 id="useeffect"><a href="#useeffect" class="header-anchor">#</a> useEffect</h3> <p>再看看 useEffect， 先来看看使用方法。 <code>useEffect(callback, dep?)</code>, 以下是一个非常简单的使用例子。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        点击
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为函数式不像 class 那样有复杂的生命周期，已经对 hooks 已经熟悉使用的你，可能会知道 <code>useEffect</code> 可以当做，<code>componentdidmount</code> 来使用。但是在这里你直接将他按照顺序执行。在 <code>return</code> 前他会执行。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> _deps <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// _deps 记录 useEffect 上一次的 依赖</span>
<span class="token keyword">function</span> <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hasChangedDeps <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> arg <span class="token operator">!==</span> _deps<span class="token punctuation">.</span>args<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 两次的 dependencies 是否完全相等</span>
  <span class="token comment">// 如果 dependencies 不存在，或者 dependencies 有变化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_deps<span class="token punctuation">.</span>args <span class="token operator">||</span> hasChangedDeps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _deps<span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>演示地址： https://codesandbox.io/s/ecstatic-glitter-w9kq7</p> <p>至此，我们也实现了单个 useEffect。</p> <h3 id="usememo"><a href="#usememo" class="header-anchor">#</a> useMemo</h3> <p>我们再来看看， useMemo，其实他也以上实现的方式一样，也是通过闭包来进行存储数据, 从而达到缓存提高性能的作用。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">computed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我执行了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> count <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>count<span class="token punctuation">}</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token punctuation">{</span>sum<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
        点击
      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来我们来进行实现</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> _deps <span class="token operator">=</span> <span class="token punctuation">{</span>
  args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// _deps 记录 useMemo 上一次的 依赖</span>
<span class="token keyword">function</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hasChangedDeps <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> arg <span class="token operator">!==</span> _deps<span class="token punctuation">.</span>args<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 两次的 dependencies 是否完全相等</span>
  <span class="token comment">// 如果 dependencies 不存在，或者 dependencies 有变化</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_deps<span class="token punctuation">.</span>args <span class="token operator">||</span> hasChangedDeps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _deps<span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
    _deps<span class="token punctuation">.</span>_callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    _deps<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> _deps<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> _deps<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>演示地址： https://codesandbox.io/s/festive-platform-v04xw</p> <h3 id="usecallback"><a href="#usecallback" class="header-anchor">#</a> useCallback</h3> <p>那么 <code>useCallback</code> 呢？ 其实就是 <code>useMemo</code> 的一个包装，毕竟你缓存函数的返回值，那么我我让返回值为一个函数不就行了？</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> callback<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，以上我们也轻松地实现了 useMemo 。但是有一个问题，以上只是单个函数使用方式，所以接下来我们还需要处理一下多个函数的情况。</p> <h3 id="完整版"><a href="#完整版" class="header-anchor">#</a> 完整版</h3> <p>我们可以按照 <a href="https://github.com/preactjs/preact/blob/master/hooks/src/index.js" target="_blank" rel="noopener noreferrer">preact<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的方法来实现。即用数组来实现多个函数的处理逻辑。</p> <p>核心逻辑就是</p> <ul><li><p>第一次声明的时候将 useState, useEffect, useMemo, useCallback 等钩子函数的状态依次存入数组。</p></li> <li><p>更新的时候，将前一次的函数状态值依次取出。</p></li></ul> <p>也可以通过以下图来理解</p> <p>第一次渲染，将每个状态都缓存到数组中。
<img src="https://s3.qiufeng.blue/blog/first-render.png" alt="first-render.png"></p> <p>每次重新渲染，获取数组中每个的缓存状态。
<img src="https://s3.qiufeng.blue/blog/re-render.png" alt="re-render.png"></p> <p>以下为了能够清晰地让大家明白原理，进行了一些删减。但是核心逻辑不变。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> currentIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> currentComponent <span class="token operator">=</span> <span class="token punctuation">{</span>
  __hooks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getHookState</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hooks <span class="token operator">=</span> currentComponent<span class="token punctuation">.</span>__hooks<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> hooks<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">argsChanged</span><span class="token punctuation">(</span><span class="token parameter">oldArgs<span class="token punctuation">,</span> newArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span>oldArgs <span class="token operator">||</span> newArgs<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> arg <span class="token operator">!==</span> oldArgs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hookState <span class="token operator">=</span> <span class="token function">getHookState</span><span class="token punctuation">(</span>currentIndex<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hookState<span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token punctuation">[</span>
    hookState<span class="token punctuation">.</span>_value <span class="token operator">?</span> hookState<span class="token punctuation">.</span>_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> initialState<span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hookState<span class="token punctuation">.</span>_value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> newState<span class="token punctuation">;</span>
      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新渲染，将会重新执行 Counter</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> hookState<span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">getHookState</span><span class="token punctuation">(</span>currentIndex<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argsChanged</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>_args<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">getHookState</span><span class="token punctuation">(</span>currentIndex<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">argsChanged</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>_args<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>_callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    state<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> state<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在用以上 43 行代码实现了一个简易的 React Hooks。</p> <h2 id="完整渲染过程"><a href="#完整渲染过程" class="header-anchor">#</a> 完整渲染过程</h2> <p>我们再通过一次整体的流程图来讲解完整版的实现。</p> <p>https://codesandbox.io/s/loving-blackburn-o7g8g</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>firstName<span class="token punctuation">,</span> setFirstName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&quot;Rudi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">computed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> count <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span>count<span class="token punctuation">}</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token punctuation">{</span>sum<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>点击<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>firstName<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setFirstName</span><span class="token punctuation">(</span><span class="token string">&quot;Fred&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Fred<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <p><img src="https://s3.qiufeng.blue/blog/1-%E5%88%9D%E5%A7%8B%E5%8C%96.png" alt="1-初始化.png"></p> <h3 id="第一次渲染"><a href="#第一次渲染" class="header-anchor">#</a> 第一次渲染</h3> <p>将所有的状态都存进闭包中。</p> <p><img src="https://s3.qiufeng.blue/blog/1-%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%B8%B2%E6%9F%93.png" alt="1-第一次渲染.png"></p> <h3 id="事件触发"><a href="#事件触发" class="header-anchor">#</a> 事件触发</h3> <p>改变了第二个状态的value值。</p> <p><img src="https://s3.qiufeng.blue/blog/1-%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91.png" alt="1-事件触发.png"></p> <h3 id="第二次渲染"><a href="#第二次渲染" class="header-anchor">#</a> 第二次渲染</h3> <p>将所有状态依次取出，进行渲染。</p> <p><img src="https://s3.qiufeng.blue/blog/1-%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93.png" alt="1-第二次渲染.png"></p> <h2 id="后记"><a href="#后记" class="header-anchor">#</a> 后记</h2> <p>通过以上的实现，我们也可以明白一些 React Hooks 中看似有点奇怪的规定了。例如为什么不要在循环、条件判断或者子函数中调用？ 因为顺序很重要，我们将缓存（状态）按一定地顺序压入数组，所以取出上一次状态，也必须以同样的顺序去获取。否则的话，会导致获取不一致的情况。。。当然我们可以试想一下，如果每个状态单元，可以有唯一的名字，那么将不会受到这些规定的约束。但是这样会使得开发带来额外的传入参数，就是唯一的名字。也会带来名字冲突等问题，因此采用这样的方式来约定，一定程度上简化了开发者的开发成本，并且也能够消除不一致性。（ps: 如果有人有兴趣，可以实现一版不依赖于顺序，只依赖于名字的，当做小玩具~）</p> <p>当然真实中的 react 是利用了单链表来代替数组的。略微有些不一样，但是本质的思路是一致的，以及 useEffect 是每次渲染完成后运行的。</p> <p>以上都是站在巨人的肩膀上（有很多优秀的文章，看参考），再加上查看一些源码得出的整个过程。最后，留出一个小问题给大家，那么每次 <code>useEffect</code> 中 <code>return 函数</code> 的逻辑又是怎么样的呢？欢迎评论区说出实现方式~ 如果文章有任何问题，也欢迎在评论区指出~</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p>https://github.com/brickspert/blog/issues/26</p> <p>https://segmentfault.com/a/1190000019824818</p> <p>https://www.zhihu.com/question/306916142</p> <p>https://zh-hans.reactjs.org/docs/hooks-faq.html#can-i-skip-an-effect-on-updates</p> <p>https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e</p> <p>https://github.com/preactjs/</p> <p>https://zh-hans.reactjs.org/docs/hooks-intro.html#motivation</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/8/2021, 1:38:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/7-react-Conditional.html" class="prev">React 条件渲染最佳实践(7 种方法)</a></span> <span class="next"><a href="/react/react-hook2.html"> 函数式编程看React Hooks(二)事件绑定副作用深度剖析</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="https://cdn.qiufeng.blue/assets/js/app.b83cabbc.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/3.8063c28d.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/2.bf4393a2.js" defer></script><script src="https://cdn.qiufeng.blue/assets/js/117.e1036e3e.js" defer></script>
  </body>
</html>
